<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DevOps for Data Science - 9&nbsp; Docker for Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../chapters/sec3/3-0-sec-intro.html" rel="next">
<link href="../../chapters/sec2/2-3-cmd-line.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BTSMMRMH08"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BTSMMRMH08', { 'anonymize_ip': true});
</script>


</head>

<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Docker for Data Science</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">DevOps for Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/akgold/do4ds" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">Welcome!</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/intro.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec1/1-0-sec-intro.html" class="sidebar-item-text sidebar-link">DevOps Lessons for Data Science</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-1-code-promotion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Code promotion and integration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-2-env-as-code.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Environments as Code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-3-data-arch.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data Pipeline Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-4-apis.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Designing Your Application Layers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-5-monitor-log.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Logging and Monitoring</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec2/2-0-sec-intro.html" class="sidebar-item-text sidebar-link">IT/Admin Tools</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-1-terminal.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Terminal</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-2-ssh.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Connecting Securely with SSH</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-3-cmd-line.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Getting comfortable on the Command Line</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-4-docker.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Docker for Data Science</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec3/3-0-sec-intro.html" class="sidebar-item-text sidebar-link">IT/Admin for Data Science</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-1-cloud.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Getting Started with the Cloud</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-2-linux-admin.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Basic Linux SysAdmin</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-3-networking.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Intro to Computer Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-4-dns.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">DNS allows for human-readable addresses</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-5-ssl.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">You should use SSL/HTTPS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-6-servers.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Choosing the right server for you</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec4/4-0-sec-intro.html" class="sidebar-item-text sidebar-link">Making it Enterprise-Grade</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-1-os-ds-in-ent.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Open Source Data Science in the Enterprise</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-2-ent-networks.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Enterprise Networking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-3-auth.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Auth in Enterprise</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-4-ent-servers.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Enterprise Server Management</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/append/docker-cheatsheet.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Docker Cheatsheet</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/append/auth.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Auth Technical Details</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/append/lab-map.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Lab Map</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#containers-are-a-packaging-tool" id="toc-containers-are-a-packaging-tool" class="nav-link active" data-scroll-target="#containers-are-a-packaging-tool"><span class="toc-section-number">9.1</span>  Containers are a Packaging Tool</a></li>
  <li><a href="#containers-for-data-science" id="toc-containers-for-data-science" class="nav-link" data-scroll-target="#containers-for-data-science"><span class="toc-section-number">9.2</span>  Containers for Data Science</a></li>
  <li><a href="#container-gotchas" id="toc-container-gotchas" class="nav-link" data-scroll-target="#container-gotchas"><span class="toc-section-number">9.3</span>  Container Gotchas</a></li>
  <li><a href="#trying-out-docker" id="toc-trying-out-docker" class="nav-link" data-scroll-target="#trying-out-docker"><span class="toc-section-number">9.4</span>  Trying out Docker</a>
  <ul class="collapse">
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites"><span class="toc-section-number">9.4.1</span>  Prerequisites</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started"><span class="toc-section-number">9.4.2</span>  Getting Started</a></li>
  </ul></li>
  <li><a href="#container-lifecycle" id="toc-container-lifecycle" class="nav-link" data-scroll-target="#container-lifecycle"><span class="toc-section-number">9.5</span>  Container Lifecycle</a></li>
  <li><a href="#understanding-docker-run" id="toc-understanding-docker-run" class="nav-link" data-scroll-target="#understanding-docker-run"><span class="toc-section-number">9.6</span>  Understanding <code>docker run</code></a>
  <ul class="collapse">
  <li><a href="#parsing-container-names" id="toc-parsing-container-names" class="nav-link" data-scroll-target="#parsing-container-names"><span class="toc-section-number">9.6.1</span>  Parsing container names</a></li>
  <li><a href="#docker-run-flags" id="toc-docker-run-flags" class="nav-link" data-scroll-target="#docker-run-flags"><span class="toc-section-number">9.6.2</span>  <code>docker run</code> flags</a></li>
  </ul></li>
  <li><a href="#build-your-own-with-dockerfiles" id="toc-build-your-own-with-dockerfiles" class="nav-link" data-scroll-target="#build-your-own-with-dockerfiles"><span class="toc-section-number">9.7</span>  Build your own with Dockerfiles</a></li>
  <li><a href="#comprehension-questions" id="toc-comprehension-questions" class="nav-link" data-scroll-target="#comprehension-questions"><span class="toc-section-number">9.8</span>  Comprehension Questions</a></li>
  <li><a href="#lab-putting-an-api-in-a-container" id="toc-lab-putting-an-api-in-a-container" class="nav-link" data-scroll-target="#lab-putting-an-api-in-a-container"><span class="toc-section-number">9.9</span>  Lab: Putting an API in a Container</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/akgold/do4ds/edit/main/chapters/sec2/2-4-docker.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-docker" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Docker for Data Science</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>If you’re in the data science world, especially the world of “production data science”, you’ve probably heard of Docker – but you might not really be sure what it is or whether you need it.</p>
<p>This chapter is designed to clarify what Docker is and how it might help you. We’ll start with a general intro to Docker, proceed with some discussion of data science-relevant Docker workflows, and then dive in to a hands-on lab that will be just the thing to get you started if you’re not sure where to go.</p>
<p>It’s worth noting that there are many entire books on how to use Docker in a software engineering context. This chapter is really just meant to give you a jumping off point. If you find that you want to get deep, I’d recommend you pick up another resource after this.</p>
<section id="containers-are-a-packaging-tool" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="containers-are-a-packaging-tool"><span class="header-section-number">9.1</span> Containers are a Packaging Tool</h2>
<p>Let’s tell a story that might feel familiar. A collaborator sends you a piece of code. You go to run it on your machine and an error pops up <code>Python 3.7 not found</code>. So you spend an hour on Stack Overflow, figuring out how to install version 3.7 of Python.</p>
<p>Then you try to run the code again, which creates some maps, and this time get an error <code>System library gdal not found</code>. “Augh!” you cry, “Why is there not a way to include all of these dependencies with the code?!?”</p>
<p>You have just discovered one of the primary use cases for a container.</p>
<p>Containers are a way to package up some code with all of its dependencies, making it easy to run the code later, share it with someone else for collaboration, or put it onto a production server – all while being reasonably confident that you won’t ever have to say, “well, it runs on my machine”.</p>
<p>Docker is by far the most popular open-source containerization platform. So much so that for most purposes container is a synonym for Docker container.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> In this chapter, containers will exclusively refer to Docker containers.</p>
<p>In addition to making it easy to get all of the dependencies with an app, Docker also makes it easy to run a bunch of different isolated apps without having them interfere with each other.</p>
<p>Virtual machines of various sorts have been around since the 1960s, and are still used for many applications. In contrast to a virtual machine, Docker is much more lightweight. Once a container has been downloaded to your machine, it can start up in less than a second.</p>
<p>This is why Docker – not the only, or even the first open source containerization system – was the first to hit the mainstream, as much as any esoteric code-development and deployment tool can be said to “hit the mainstream”.</p>
<p>This means that – for the most part – anything that can run in a Docker container in one place can be run on another machine with very minimal configuration.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are exceptions. Until recently, a huge fraction of laptop CPUs were of a particular architecture called <code>x86</code>.</p>
<p>Apple’s recent M1 and M2 chips run on an ARM64 architecture, which had previously been used almost exclusively for phones and tablets. The details aren’t super important, but the upshot is that getting containers working on Apple silicon may not be trivial.</p>
</div>
</div>
<p>Docker doesn’t completely negate the need for other sorts of IT tooling, because you still have to provision the physical hardware somehow, but it does make everything much more self-contained. And if you’ve already got a laptop, you can easily run Docker containers with just a few commands (we’ll get to that below).</p>
</section>
<section id="containers-for-data-science" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="containers-for-data-science"><span class="header-section-number">9.2</span> Containers for Data Science</h2>
<p>In a data science context, there are two main ways you might use containers – as a way to package a development environment for someone else to use, and as a way to package a finished app for archiving, reproducibility, and production.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
The Data Science Reproducibility Stack
</div>
</div>
<div class="callout-body-container callout-body">
<p>A reminder from the <a href="#repro">reproducibility chapter</a>:</p>
<p><em>The data science reproducibility stack generally includes 6 elements:</em></p>
<ol type="1">
<li><em>Code</em></li>
<li><em>Data</em></li>
<li><em>R + Python Packages</em></li>
<li><em>R + Python Versions</em></li>
<li><em>Other System Libraries</em></li>
<li><em>Operating System</em></li>
</ol>
</div>
</div>
<p>If you’re running RStudio Server or JupyterHub on a centralized server, Docker can be a great way to maintain that server. In my opinion, maintaining a Docker container is one of the easiest ways to start on an infrastructure-as-code journey.</p>
<p>We’re not going to get terribly deep into this use case, as creating the overwhelming majority of the work involved is standard IT/Admin tasks for hosting a server - things like managing networking, authentication and authorization, security, and more.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you’re thinking about hosting a data science workbench in Docker, you should think carefully about whether you want to deal with standalone containers, or whether you’re really looking for <a href="#k8s"><em>container orchestration</em></a> using <em>Kubernetes</em>.</p>
</div>
</div>
<p>In this chapter, I’ll suggest trying to stand up RStudio Server in a container on your desktop, but don’t let the ease fool you. The majority of difficulties with administering a server are the same, even if you put your application stack into a Docker container. Section II of this book will have a lot more on those challenges, and I suggest you check it out if you’re interested.</p>
<p>Instead, we’re going to stick with talking about how actual data scientists would want to use Docker: to archive and share completed data science assets.</p>
<p><img src="images-docker/docker-usage.png" class="img-fluid"></p>
<p>In this pattern, you’ll put your whole reproducibility stack inside the container itself – perhaps minus your data.</p>
</section>
<section id="container-gotchas" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="container-gotchas"><span class="header-section-number">9.3</span> Container Gotchas</h2>
<p>Docker containers are great for certain purposes, but there are also some tradeoffs that it’s worth being aware of.</p>
<p>The first is the tradeoff of Docker’s strength: a container only gets access to the resources it has specifically been allowed to access.</p>
<p>This is a great feature for security and process isolation, but it means you may run into some issues with networking and access to system resources, like your files. You’ll have to develop a reasonably good mental model of the relationship of the Docker container to the rest of your machine in order to be able to develop effectively.</p>
<p>It’s worth noting that in some environments – especially highly-regulated ones – a Docker container may not be a sufficient level of reproducibility. Differences between machines at the physical hardware level could potentially mean that numeric solutions could differ across machines, even with the same container. You probably know if you’re in this kind of environment and you have to maintain physical machines.</p>
<p>There are also several antipatterns that using a container could facilitate.</p>
<p>The biggest reproducibility headache for most data scientists is managing R and Python package environments. While you can just install a bunch of packages into a container, save the container state, and move on, this really isn’t a good solution.</p>
<p>If you do this, you’ve got the last state of your environment saved, but it’s not really reproducible. If you come back next year and need to add a new package, you’ll have no way to do it without potentially breaking the whole environment.</p>
<p>The obvious solution is to write down the steps for creating your Docker container – in a file called a Dockerfile. Here, it’s tempting to create a Dockerfile that looks like:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb1-1"><a href="#cb1-1"></a>...</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">RUN</span> <span class="ex">/opt/R/4.1.0/bin/R</span> install.packages<span class="er">(</span><span class="ex">c</span><span class="er">(</span><span class="st">"shiny"</span><span class="ex">,</span> <span class="st">"dplyr"</span><span class="kw">))</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But this is also completely non-reproducible. Whenever you rebuild your container, you’ll install the newest versions of Shiny and Dplyr afresh, potentially ruining the reproducibility of your code. For that reason, the best move is to still use R- and Python-specific libraries for capturing package state – like <code>renv</code> and <code>rig</code> in R and <code>virtualenv</code> , <code>conda</code> , and <code>pyenv</code> in Python – rather than relying on Docker for that job. There’s more on those topics in the <a href="../sec1/1-2-env-as-code.html">Chapter&nbsp;<span>2</span></a> on environments.</p>
</section>
<section id="trying-out-docker" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="trying-out-docker"><span class="header-section-number">9.4</span> Trying out Docker</h2>
<p>If you’ve read this far, you probably have a reasonably good mental model of when you might want to use Docker to encapsulate your data science environment or when you might not. The rest of this chapter will be a hands-on intro to using Docker to run a finished app.</p>
<section id="prerequisites" class="level3" data-number="9.4.1">
<h3 data-number="9.4.1" class="anchored" data-anchor-id="prerequisites"><span class="header-section-number">9.4.1</span> Prerequisites</h3>
<p>In order to get started with Docker, you’ll need to know a few things. The first is that you’ll have to actually have Docker installed on an environment you can use. The easiest way to do this is to install <a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a> on your laptop, but you can also put Docker on a server environment.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We’re going to use Docker from a terminal on your machine. I’ll give you all the commands you’ll need, but you need to know how to find and open a terminal.</p>
<p>If that’s new to you, you might want to skip ahead and check out the beginning of <a href="2-3-cmd-line.html">Chapter&nbsp;<span>8</span></a> so you can at least open a terminal.</p>
</div>
</div>
</section>
<section id="getting-started" class="level3" data-number="9.4.2">
<h3 data-number="9.4.2" class="anchored" data-anchor-id="getting-started"><span class="header-section-number">9.4.2</span> Getting Started</h3>
<p>Let’s get started with an example that demonstrates the power of Docker right off the bat.</p>
<p>TODO: put model in S3</p>
<p>Once you’ve got Docker Desktop installed and running, type the following in your terminal:</p>
<pre><code>docker run --rm -d \
  -p 8080:8080 \
  --name palmer-plumber \
  alexkgold/plumber</code></pre>
<p>Once you type in this command, it’ll take a minute to pull, extract, and start the container.</p>
<p>Once the container starts up, you’ll see a long sequence of letters and numbers. Now, navigate to <code>http://localhost:8080</code>in your browser (this URL has to be exact!), and you should see the documentation for an R language API that lets you explore the <a href="https://allisonhorst.github.io/palmerpenguins/">Palmer Penguins data set</a></p>
<p>That was probably pretty uninspiring. It took a long time to download and get started. In order to show the real power of Docker, let’s now kill the container with</p>
<pre><code>docker kill palmer-plumber</code></pre>
<p>You can check that the container isn’t running by trying to visit that URL again. You’ll get an error.</p>
<p>Let’s bring the container back up by running the <code>docker run</code> command above again.</p>
<p>This time is should be quick – probably less than a second – now that you’ve got the container downloaded. THIS is the power of Docker.</p>
<hr>
<p>As you click around, seeing penguin stats and seeing plots, you might notice that nothing is showing up on the command line…but what if I want logs of what people are doing? Or I need to look at the app code?</p>
<p>You can get into the container to poke around using the command</p>
<pre><code>docker exec -it palmer-plumber /bin/bash</code></pre>
<p>Once you’re in, try <code>cat api/plumber.R</code> to look at the code of the running API.</p>
<p>When you need to get out, you can leave by typing <code>exit</code>.</p>
<p><code>docker exec</code> is a general purpose command for executing a command inside a running container. The overwhelming majority of the time I use it, it’s to get a terminal inside a running container so I can poke around.</p>
<p>You can spend a lot of time getting deep into why the command works, but just memorizing (or, more likely, repeatedly googling) <code>docker exec -it &lt;container&gt; /bin/bash</code> will get you pretty far.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you’re used to running things on servers, you might be in the habit of <code>SSH</code>-ing in, poking around, and fixing things that are broken. This isn’t great for a lot of reasons, but it’s a huge anti-pattern in Docker land.</p>
<p>Containers are <em>stateless</em> and <em>immutable</em>. This means that anything that happens in the container stays in the container – even when the container goes away. If something goes wrong in your running container, you may need to exec in to poke around, but you should fix it by rebuilding and redeploying your image, not by changing the running container.</p>
</div>
</div>
<p>One nicety of Docker is that it gives you quick access to the most common reason you’d probably exec into the container – looking at logs.</p>
<p>After you’ve clicked around a little in the API, try running:</p>
<pre><code>docker logs palmer-plumber</code></pre>
<p>We’re done with this container now. Feel free to kill it before you move on.</p>
<hr>
<p>Great! We’ve played around with this container pretty thoroughly.</p>
<p>Before we get into how this all works, let’s try one more example.</p>
<p>Go back into your terminal and navigate to a directory you can play around in (the <code>cd</code> command is your friend here, see <a href="2-3-cmd-line.html">Chapter&nbsp;<span>8</span></a> if you’re not familiar). Run the following in your terminal:</p>
<pre><code>docker run \
-v ${PWD}:/project-out \
alexkgold/batch:0.1</code></pre>
<p>It’ll take a minute to download – this container is about 600Mb. You may need to grant the container access to a directory on your machine when it runs. This container will take a few moments to run. If you go to the directory in file browser, you should be able to open <code>hello.html</code> in your web browser – it should be a rendered version of a Jupyter Notebook.</p>
<p>This notebook is just a very basic visualization, but you can see how it’s nice to be able to render a Jupyter Notebook locally without having to worry about making sure you had any of the dependencies installed. This is good both for running on demand, and also for archival purposes.</p>
<hr>
<p>Now that we’ve got Docker working for you, let’s take a step back, explain what we just did, and dive deeper into how this can be helpful.</p>
<p>Hopefully these two examples are exciting – in the first, we got an interactive web API running like a server on our laptop in just a few seconds – and without installing any of the packages or even a version of R locally. In the second, we rendered a Jupyter Notebook using the <a href="https://quarto.org/">quarto</a> library – again, without worrying about downloading it locally.</p>
</section>
</section>
<section id="container-lifecycle" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="container-lifecycle"><span class="header-section-number">9.5</span> Container Lifecycle</h2>
<p>Before we dig into the nitty-gritty of how that all worked – and how you might change it for your own purposes, let’s spend just a minute clarifying the lifecycle of a Docker container.</p>
<p>This image explains the different states a Docker container can be in, and the commands you’ll need to move them around.</p>
<p><img src="images-docker/docker-lifecycle.png" class="img-fluid" width="561"></p>
<p>A container starts its life as a <em>Dockerfile</em>. A Dockerfile is a set of instructions for how to build a container. Dockerfiles are usually stored in a git repository, just like any other code, and it’s common to build them on push via a CI/CD pipeline.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>A working Dockerfile gets built into a <em>Docker image</em> with the <em>build</em> command. Images are immutable snapshots of the state of the container at a given time.</p>
<p>It is possible to interactively build a container as you go and snapshot to create an image, but for the purposes of reproducibility, it’s generally preferable to build the image from a Dockerfile, and adjust the Dockerfile if you need to adjust the image.</p>
<p>Usually, the image is going to be the thing that you share with other people, as it’s the version of the container that’s compiled and ready to go.</p>
<p>Docker images can be shared directly like any other file, or via sharing on an <em>image registry</em> via the <em>push</em> and <em>pull</em> commands.</p>
<p>If you’re familiar with git, the mental model for Docker is quite similar. There is a public Docker Hub you can use, and it’s also possible to run private image registries. Many organizations make use of the <em>image registries as a service</em> offerings from cloud providers. The big 3’s are Amazon’s Elastic Container Registry (ECR), Azure Container Registry, and Google Container Registry.</p>
<p>Once you’ve got an image downloaded locally, you can run it with the <em>run</em> command. Note that you generally don’t have to pull before running a container, as it will auto-pull if it’s not available.</p>
<p>Now that you’re all excited, let’s dig in on how the <code>docker run</code> command works, and the command line flags we used here, which are the ones you’ll use most often.</p>
</section>
<section id="understanding-docker-run" class="level2" data-number="9.6">
<h2 data-number="9.6" class="anchored" data-anchor-id="understanding-docker-run"><span class="header-section-number">9.6</span> Understanding <code>docker run</code></h2>
<p>At it’s most basic, all you need to know is that you can run a Docker image locally using the <code>docker run &lt;name&gt;</code> command. However, Docker commands usually use a lot of command line flags – so many that it’s easy to miss what the command actually is.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A command line flag is an argument passed to a command line program.</p>
<p>There’s a lot more about using command line tools in <a href="2-3-cmd-line.html">Chapter&nbsp;<span>8</span></a>.</p>
</div>
</div>
<p>Let’s pull apart the two commands we just used, which use the command line flags you’re most likely to need.</p>
<section id="parsing-container-names" class="level3" data-number="9.6.1">
<h3 data-number="9.6.1" class="anchored" data-anchor-id="parsing-container-names"><span class="header-section-number">9.6.1</span> Parsing container names</h3>
<p>To start with, let’s parse the name of the container. In this example, you used two different container names – <code>alexkgold/plumber</code> and <code>alexkgold/batch:0.1</code>. All containers have an id, and they may also have a tag. If you’re using the public <a href="https://hub.docker.com">DockerHub</a> registry, like I am, container ids are of the form <code>&lt;user&gt;/&lt;name&gt;</code>. This should look very familiar if you already use a git repository.</p>
<p>In addition to an id, containers can also have a tag. For example, for the <code>alexkgold/batch</code> image, we specified a version: <code>0.1</code>. If you don’t specify a tag when pulling or pushing an image, you’ll automatically create or get <code>latest</code> – the newest version of a container that was pushed to the registry.</p>
<p>Users often create tags that are relevant to the container – often versions of the software contained within. For example, the <code>rocker/r-ver</code> container, which is a container pre-built with a version of R in it uses tags for the version of R.</p>
<p>All these examples use the public DockerHub. Many organizations use a private image registry, in which case you can prefix the container name with the URL of the registry.</p>
</section>
<section id="docker-run-flags" class="level3" data-number="9.6.2">
<h3 data-number="9.6.2" class="anchored" data-anchor-id="docker-run-flags"><span class="header-section-number">9.6.2</span> <code>docker run</code> flags</h3>
<p>In this section we’re going to go through the docker run flags we used in quite a bit of detail.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you just want a quick reference later, there’s a cheatsheet in <span class="citation" data-cites="docker-cheat">[Appendix @docker-cheat]</span>.</p>
</div>
</div>
<p>Let’s first look at how we ran the container with the plumber API in it.</p>
<p>For this container, we used the <code>--rm</code> flag, the <code>-d</code> flag, the <code>-p</code> flag with the argument <code>8080:8080</code>, and the <code>--name</code> flag with the argument <code>plumber-palmer</code>.</p>
<p>The <code>--rm</code> flag <em>removes</em> the container after it finishes running. This is nice when you’re just playing around with a container locally because then you can use the same container name repeatedly, but it’s a flag you’ll almost never use in production because it removes everything from the container, including logs.</p>
<p>You can check this by running <code>docker kill palmer-plumber</code> to make sure the container is down and then try to get to the logs with <code>docker logs palmer-plumber</code>. But they don’t exist because they got cleaned up!</p>
<p>Feel free to try running to container without the <code>--rm</code> flag, playing around, killing the container, and then looking at the logs. Before you’re able to bring back another container with the same name, you’ll have to remove the container with <code>docker rm palmer-plumber</code>.</p>
<p>The <code>-d</code> flag instructs the container to run in <em>detached</em> mode so the container won’t block the terminal session. You can feel free to run the container attached – but you’ll have to quit the container by aborting the command from inside the terminal (<code>Ctrl + c</code>), or opening another terminal to <code>docker kill</code> the container.</p>
<p>The <code>-p</code> flag <em>publishes</em> a port from inside the container to the host machine. So by specifying <code>-p 8080:8080</code>, we’re taking whatever’s available on the port <code>8080</code> inside the container and making it available at the same port on the <code>localhost</code> of the machine that’s hosting the container.</p>
<p>TODO: picture of ports</p>
<p>Port forwarding is always specified as <code>&lt;host port&gt;:&lt;container port&gt;</code>. Try playing around with changing the values to make the API available on a different port, perhaps <code>9876</code>. For a more in-depth treatment of ports, see <a href="../sec3/3-3-networking.html">Chapter&nbsp;<span>12</span></a>.</p>
<p>The <code>--name</code> flag gives our container a name. This is really just a convenience so that you could do commands like <code>docker kill</code> in terms of the container name, rather than the container ID, which will be different for each person who runs the command.</p>
<p>In a lot of cases, you won’t bother with a name for the container.</p>
<p>You can find container ID using the <code>docker ps</code> command to get the <em>process status</em>. In the case below, I could control the container with the name <code>palmer-plumber</code>, or with the container ID. You can abbreviate container IDs as long as they’re unique – I tend to use the first three characters.</p>
<pre><code>❯ docker ps                                                         [12:23:13]

CONTAINER ID   IMAGE               COMMAND                  CREATED          STATUS          PORTS                    NAMES

35bd54e44015   alexkgold/plumber   "R -e 'pr &lt;- plumber…"   29 seconds ago   Up 28 seconds   0.0.0.0:8080-&gt;8080/tcp   palmer-plumber</code></pre>
<hr>
<p>Now let’s head over to the batch document rendering, where we only used one command line flag <code>-v ${PWD}:/project-out</code>, short for <em>volume</em>. To demonstrate what this argument does, navigate to a new directory on your command line and re-run the container without the argument.</p>
<p>Wait…where’d my document go?</p>
<p>Remember – containers are completely ephemeral. <em>What happens in the container stays in the container</em>. This means that when my document is rendered inside the container, it gets deleted when the container ends its job.</p>
<p>But that’s not what I wanted – I wanted to get the output back out of the container.</p>
<p>The solution – making data outside the container available to the container and vice-versa – is accomplished by <em>mounting a volume</em> into the container using the <code>-v</code> flag. Like with mounting a port, the syntax is <code>-v &lt;directory outside container&gt;:&lt;directory inside container&gt;</code>.</p>
<p><img src="images-docker/docker-on-host.png" class="img-fluid" width="2048"></p>
<p>This is an essential concept to understand when working with containers. Because containers are so ephemeral, volumes are the way to get anything from your host machine in, and to persist anything that you want to outlast the lifecycle of the container.</p>
<p>In this case, we actually used a variable <code>${PWD}</code>, which will be evaluated to the current working directory to be the directory <code>project-out</code> inside the container, so the rendered document can be persisted after the container goes away.</p>
</section>
</section>
<section id="build-your-own-with-dockerfiles" class="level2" data-number="9.7">
<h2 data-number="9.7" class="anchored" data-anchor-id="build-your-own-with-dockerfiles"><span class="header-section-number">9.7</span> Build your own with Dockerfiles</h2>
<p>So far, we’ve just been running containers based on images I’ve already prepared for you. Let’s look at how those images were created so you can try building your own.</p>
<p>A Dockerfile is just a set of instructions that you use to build a Docker image. If you have a pretty good idea how to accomplish something on a running machine, you shouldn’t have too much trouble building a Dockerfile to do the same, as long as you remember two things:</p>
<p>TODO: Image of build vs run time</p>
<ol type="1">
<li>The difference between <em>build</em> time and <em>run</em> time. There are things that should happen at build time – like setting up the versions of R and Python, copying in the code you’ll run, and installing the system requirements. That’s very different from the thing I want to have happen at run time – rendering the notebook or running the API.</li>
<li>Docker containers only have access to exactly the resources you provide to them at both build and runtime. That means that they won’t have access to libraries or programs unless you give them access, and you also won’t have access to files from your computer unless you make them available.</li>
</ol>
<p>There are many different commands you can use inside a Dockerfile, but with just a handful, you’ll be able to build most images you might need.</p>
<p>Here are the important commands you’ll need for getting everything you need into your images.</p>
<ul>
<li><p><code>FROM</code> – every container starts from a base image. In some cases, like in my Jupyter example, you might start with a bare bones container that’s just the operating system (<code>ubuntu:20.04</code>). In other cases, like in my <code>shiny</code> example, you might start with a container that’s almost there, and all you need to do is to copy in a file or two.</p></li>
<li><p><code>RUN</code> – run any command as if you were sitting at the command line inside the container. Just remember, if you’re starting from a very basic container, you may need to make a command available before you can run it (like <code>wget</code> in my container below).</p></li>
<li><p><code>COPY</code> – copy a file from the host filesystem into the container. Note that the working directory for your Dockerfile will be whatever your working directory is when you run your build command.</p></li>
</ul>
<p>One really nice thing about Docker containers is that they’re built in <em>layers</em>. Each command in the Dockerfile defines a new layer. If you make changes below a given layer in your Dockerfile, rebuilding will be easy, because Docker will only start rebuilding at the layer with changes.</p>
<p>If you’re mainly building containers for finished data science assets to be re-run on demand, there’s only one command you need:</p>
<ul>
<li><code>CMD</code> - Specifies what command to run inside the container’s shell at runtime. This would be the same command you’d use to run your project from the command line.</li>
</ul>
<p>If you do much digging, you’ll probably run into the <code>ENTRYPOINT</code> command, which can take a while to tell apart from <code>CMD</code>. If you’re building containers to run finished data science assets, you shouldn’t need <code>ENTRYPOINT</code>. If you’re building containers to – for example – accept a different asset to run or allow for particular arguments, you’ll need to use <code>ENTRYPOINT</code> to specify the command that will always run and <code>CMD</code> to specify the default arguments to <code>ENTRYPOINT</code>, which can be overridden on the command line.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>Here’s the Dockerfile I used to build the container for the Jupyter Notebook rendering. Look through it. Can you understand what it’s doing?</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># </span><span class="cv">syntax=docker/dockerfile:1</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">FROM</span> ubuntu:20.04</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co"># Copy external files</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw">RUN</span> <span class="fu">mkdir</span> <span class="at">-p</span> /project/out/</span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="kw">COPY</span> ./requirements.txt /project/</span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="kw">COPY</span> ./hello.ipynb /project/</span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co"># Install system packages</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="dt">\</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>  wget python3 python3-pip</span>
<span id="cb8-13"><a href="#cb8-13"></a></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="co"># Install quarto CLI + clean up</span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="kw">RUN</span> <span class="fu">wget</span> https://github.com/quarto-dev/quarto-cli/releases/download/v0.9.83/quarto-0.9.83-linux-amd64.deb</span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="kw">RUN</span> <span class="ex">dpkg</span> <span class="at">-i</span> ./quarto-0.9.83-linux-amd64.deb</span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="kw">RUN</span> <span class="fu">rm</span> <span class="at">-f</span> ./quarto-0.9.83-linux-amd64.deb</span>
<span id="cb8-18"><a href="#cb8-18"></a></span>
<span id="cb8-19"><a href="#cb8-19"></a><span class="co"># Install Python requirements</span></span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="kw">RUN</span> <span class="ex">pip3</span> install <span class="at">-r</span> /project/requirements.txt</span>
<span id="cb8-21"><a href="#cb8-21"></a></span>
<span id="cb8-22"><a href="#cb8-22"></a><span class="co"># Render notebook</span></span>
<span id="cb8-23"><a href="#cb8-23"></a><span class="kw">CMD</span> <span class="bu">cd</span> /project <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>  <span class="ex">quarto</span> render ./hello.ipynb <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>  <span class="co"># Move output to correct directory</span></span>
<span id="cb8-26"><a href="#cb8-26"></a>  <span class="co"># Needed because quarto requires relative paths in --output-dir: </span></span>
<span id="cb8-27"><a href="#cb8-27"></a>  <span class="co"># https://github.com/quarto-dev/quarto-cli/issues/362</span></span>
<span id="cb8-28"><a href="#cb8-28"></a>  rm -rf /project-out/hello_files/ &amp;&amp; <span class="op">\</span></span>
<span id="cb8-29"><a href="#cb8-29"></a>  mkdir -p /project-out/hello_files &amp;&amp; <span class="op">\</span></span>
<span id="cb8-30"><a href="#cb8-30"></a>  mv ./hello_files/* /project-out/hello_files/ &amp;&amp; <span class="op">\</span></span>
<span id="cb8-31"><a href="#cb8-31"></a>  mv ./hello.html /project-out/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once you’ve created your Dockerfile, you build it into an image using <code>docker build -t &lt;image name&gt;</code>. You can then push that to DockerHub or another registry using <code>docker push</code>.</p>
</section>
<section id="comprehension-questions" class="level2" data-number="9.8">
<h2 data-number="9.8" class="anchored" data-anchor-id="comprehension-questions"><span class="header-section-number">9.8</span> Comprehension Questions</h2>
<ol type="1">
<li>What does using a Docker container for a data science project make easier? What does it make harder?</li>
<li>Draw a mental map of the relationship between the following: Dockerfile, Docker Image, Docker Registry, Docker Container</li>
<li>When would you want to use each of the following flags for <code>docker run</code>? When wouldn’t you?
<ul>
<li><code>-p</code>, <code>--name</code>, <code>-d</code>, <code>--rm</code>, <code>-v</code></li>
</ul></li>
<li>What are the most important Dockerfile commands?</li>
</ol>
</section>
<section id="lab-putting-an-api-in-a-container" class="level2" data-number="9.9">
<h2 data-number="9.9" class="anchored" data-anchor-id="lab-putting-an-api-in-a-container"><span class="header-section-number">9.9</span> Lab: Putting an API in a Container</h2>
<p>Let’s put our Penguin model prediction API from <a href="../sec1/1-4-apis.html">Chapter&nbsp;<span>4</span></a> into a container.</p>
<p>Again, Vetiver has some nice tooling to make this very easy to do. You should follow the instructions on the <code>{vetiver}</code> website for how to generate your Dockerfile.</p>
<p>One thing to note about this container – it follows best practices for how to put data (in this case the machine-learning model) into the container. That means the model <em>isn’t</em> built into the container. Instead, the container knows how to fetch the model.</p>
<p>That means that you’ll need to have the <code>model_board</code> object available. Look back at <a href="../sec1/1-4-apis.html#lab4">Lab 4</a> if you’ve restarted your Python session since you last ran the <code>{vetiver}</code> code.</p>
<p>Once you’ve generated your Dockerfile, take a look at it. Here’s the one for my model:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Dockerfile</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-eval="false"><pre class="sourceCode numberSource Dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># # Generated by the vetiver package; edit with care</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co"># start with python base image</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="kw">FROM</span> python:3.9</span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co"># create directory in container for vetiver files</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="kw">WORKDIR</span> /vetiver</span>
<span id="cb9-7"><a href="#cb9-7"></a></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co"># copy  and install requirements</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="kw">COPY</span> vetiver_requirements.txt /vetiver/requirements.txt</span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="co">#</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">--no-cache-dir</span> <span class="at">--upgrade</span> <span class="at">-r</span> /vetiver/requirements.txt</span>
<span id="cb9-13"><a href="#cb9-13"></a></span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="co"># copy app file</span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="kw">COPY</span> app.py /vetiver/app/app.py</span>
<span id="cb9-16"><a href="#cb9-16"></a></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="co"># expose port</span></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="kw">EXPOSE</span> 8080</span>
<span id="cb9-19"><a href="#cb9-19"></a></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="co"># run vetiver API</span></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="kw">CMD</span> [<span class="st">"uvicorn"</span>, <span class="st">"app.app:api"</span>, <span class="st">"--host"</span>, <span class="st">"0.0.0.0"</span>, <span class="st">"--port"</span>, <span class="st">"8080"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This auto-generated Dockerfile is very nicely commented, so its easy to follow.</p>
<p>Now build the container using <code>docker build -t penguin-model-local .</code>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>docker build</code> command will only work if you’re in the directory with the container.</p>
</div>
</div>
<p>Ok, now let’s run the container using</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="co">#| eval: false</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="ex">docker</span> run <span class="at">--rm</span> <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="at">-p</span> 8080:8080 <span class="dt">\</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="at">--name</span> penguin-model <span class="dt">\</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>  penguin-model-local</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you go to <code>http://localhost:8080</code> you’ll find that…it doesn’t work? Why? If you run the container attached (remove the <code>-d</code> from the run command) you’ll get some feedback that might be helpful.</p>
<p>In line 15 of the Dockerfile, we copied the <code>app.py</code> in to the container. Let’s take a look at that file to see if we can find any hints.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode" id="cb11" data-eval="false"><pre class="sourceCode numberSource Python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="im">from</span> vetiver <span class="im">import</span> VetiverModel</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="im">import</span> vetiver</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="im">import</span> pins</span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a></span>
<span id="cb11-6"><a href="#cb11-6"></a>b <span class="op">=</span> pins.board_folder(<span class="st">'/var/folders/t9/kw5hnztj68d6_37dm5rw8n_h0000gn/T/tmpti3uqb2x'</span>, allow_pickle_read<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-7"><a href="#cb11-7"></a>v <span class="op">=</span> VetiverModel.from_pin(b, <span class="st">'penguin_model'</span>)</span>
<span id="cb11-8"><a href="#cb11-8"></a></span>
<span id="cb11-9"><a href="#cb11-9"></a>vetiver_api <span class="op">=</span> vetiver.VetiverAPI(v)</span>
<span id="cb11-10"><a href="#cb11-10"></a>api <span class="op">=</span> vetiver_api.app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Look at that (very long) line 6. The API is connecting to a local directory to pull the model. Is your spidey sense tingling? Something about container filesystem vs host filesystem?</p>
<p>That’s right – the temp file indicated is inside the <code>/var</code> directory on <em>my machine</em>, but that directory doesn’t exist at <code>/var</code> inside the container when it’s running. In order to get this to work, I’ve got to mount the model in at run time.</p>
<p>Add a <code>-v /var:/var</code> to your run command like so</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">#| eval: false</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="ex">docker</span> run <span class="at">--rm</span> <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="at">-p</span> 8080:8080 <span class="dt">\</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="at">--name</span> penguin-model <span class="dt">\</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>  <span class="at">-v</span> /var:/var <span class="dt">\</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>  penguin-model-local</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Depending on the permissions of the <code>/var</code> directory on your machine, you <em>may</em> need to run the <code>docker run</code> command prefixed by <code>sudo</code>.</p>
</div>
</div>
<p>And NOW you should be able to get your model up in no time.</p>
<p>In <a href="../sec3/3-1-cloud.html">Chapter&nbsp;<span>10</span></a>, we’ll worry about putting the model somewhere more permanent so you don’t have to worry about this issue.</p>


</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>There are some other types of containers that are commonly used for specialized use cases, like high-performance computing.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Remember, we talked about them back in <a href="../sec1/1-1-code-promotion.html">Chapter&nbsp;<span>1</span></a>!<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>This might sound backward – the key is to realize that this is always how it works. The default <code>ENTRYPOINT</code> is <code>/bin/sh -c</code>, so <code>CMD</code> is always just providing arguments to the <code>ENTRYPOINT</code>.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>

<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../chapters/sec2/2-3-cmd-line.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Getting comfortable on the Command Line</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../chapters/sec3/3-0-sec-intro.html" class="pagination-link">
        <span class="nav-page-text">IT/Admin for Data Science</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, Alex K Gold</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link active" href="https://github.com/akgold/do4ds" aria-current="page">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/alexkgold">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>