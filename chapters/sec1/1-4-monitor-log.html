<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DevOps for Data Science - 4&nbsp; Logging and Monitoring</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../chapters/sec1/1-5-deployments.html" rel="next">
<link href="../../chapters/sec1/1-3-data-access.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EQR1RYSHQK"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-EQR1RYSHQK', { 'anonymize_ip': true});
</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../chapters/sec1/1-0-sec-intro.html">DevOps Lessons for Data Science</a></li><li class="breadcrumb-item"><a href="../../chapters/sec1/1-4-monitor-log.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Logging and Monitoring</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">DevOps for Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/akgold/do4ds" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec1/1-0-sec-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DevOps Lessons for Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-1-env-as-code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Environments as Code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-2-proj-arch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Project Architecture Guidelines</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-3-data-access.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Using databases and data APIs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-4-monitor-log.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Logging and Monitoring</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-5-deployments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Deployments and code promotion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec2/2-0-sec-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IT/Admin Tools</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-1-cmd-line.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Opening the Command Line</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-2-cmd-line-use.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Using the Command Line</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-3-ssh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Secure server connections with SSH</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-4-docker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Demystifying Docker</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec3/3-0-sec-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IT/Admin for Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-1-cloud.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Getting Started with the Cloud</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-2-linux-admin.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Basic Linux SysAdmin</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-3-networking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Intro to Computer Networks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-4-dns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">DNS allows for human-readable addresses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-5-ssl.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">You should use SSL/HTTPS</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-6-servers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Choosing the right server for you</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec4/4-0-sec-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Making it Enterprise-Grade</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-1-os-ds-in-ent.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Open Source Data Science in the Enterprise</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-2-ent-networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Enterprise Networking</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-3-auth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Auth in Enterprise</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-4-ent-servers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Enterprise Server Management</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/append/auth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Auth Technologies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/append/lab-map.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Lab Map</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#observing-correctness" id="toc-observing-correctness" class="nav-link active" data-scroll-target="#observing-correctness"><span class="header-section-number">4.1</span> Observing Correctness</a></li>
  <li><a href="#observing-operations" id="toc-observing-operations" class="nav-link" data-scroll-target="#observing-operations"><span class="header-section-number">4.2</span> Observing Operations</a>
  <ul class="collapse">
  <li><a href="#understanding-log-levels" id="toc-understanding-log-levels" class="nav-link" data-scroll-target="#understanding-log-levels"><span class="header-section-number">4.2.1</span> Understanding log levels</a></li>
  <li><a href="#configuring-log-formats-and-log-handling" id="toc-configuring-log-formats-and-log-handling" class="nav-link" data-scroll-target="#configuring-log-formats-and-log-handling"><span class="header-section-number">4.2.2</span> Configuring log formats and log handling</a></li>
  <li><a href="#working-with-metrics" id="toc-working-with-metrics" class="nav-link" data-scroll-target="#working-with-metrics"><span class="header-section-number">4.2.3</span> Working with Metrics</a></li>
  </ul></li>
  <li><a href="#comprehension-questions" id="toc-comprehension-questions" class="nav-link" data-scroll-target="#comprehension-questions"><span class="header-section-number">4.3</span> Comprehension Questions</a></li>
  <li><a href="#lab-4-an-app-with-logging" id="toc-lab-4-an-app-with-logging" class="nav-link" data-scroll-target="#lab-4-an-app-with-logging"><span class="header-section-number">4.4</span> Lab 4: An App with Logging</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/akgold/do4ds/edit/main/chapters/sec1/1-4-monitor-log.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-log-monitor" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Logging and Monitoring</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>You get a call, a text, a slack. A bead of cold sweat runs down your back. All you know – it seems all you’ve every known – is your failed job or error-bound app, which the CEO, of course, needs <em>right now</em>.</p>
<p>It didn’t have to be this way. You can’t control whether code will fail – it will. And you can’t ensure it’ll happen at a convenient time. But you can live in a world where you sleep soundly at night knowing that you’ll know when issues arise and that you’ll be able to quickly figure out why they’re happening.</p>
<p>The key to living in that world is <em>observability</em>. If your code is observable, you’ll be alerted when something goes wrong because you have enabled <em>monitoring</em> on the system and when you dig in, you’ll have <em>logging</em> that lets you reconstruct the pathway to failure.</p>
<p>Beyond sleeping soundly, making your work more observable can also help you demonstrate its value. Being able to demonstrate who is using your work and what they’re accessing can really help show decision makers that your team matters.</p>
<p>In this chapter we’ll get into how to make your code observable. You’ll learn how to use tooling in R and Python to see what’s going on inside your data science project. I’ll also give you some tips on particular things I always monitor or log and how to consume and use the metrics and logs your project is now emitting.</p>
<section id="observing-correctness" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="observing-correctness"><span class="header-section-number">4.1</span> Observing Correctness</h2>
<p>Observability of general purpose software is primarily concerned with the <em>operational</em> qualities of the software. A software engineer wants to know whether their software is using too much RAM or CPU, whether its fast enough, and whether its crashed.</p>
<p>For a general purpose software engineer, an uncaught exception that makes the software crash is about as bad as it gets.</p>
<p>But for a data scientist there’s something even scarier – an issue that doesn’t result in code failure but yields incorrect answers. Data joins usually complete even if the merge quality is really bad. Model APIs will return a prediction even if the prediction is very, very bad.</p>
<p>It’s hard to check the actual correctness of the numbers and figures work work returns because you’re (basically by definition) doing something novel. So you’re basically left putting process metrics in place that can help reveal a problem before it surfaces.</p>
<p>One important tool you have in your toolbox is correctly architecting your project. Jobs are generally much easier to check for correctness than presentation layers. By moving as much processing as possible out of the presentation layer and into the data and processing layers, you can make it easier to observe.</p>
<p>Moreover, you’re already very familiar with tools for <em>literate programming</em> like Jupyter Notebooks, R Markdown Documents, and Quarto Documents.</p>
<p>One of my spicier opinions is that <em>all</em> jobs should be in a literate programming format. These tools, when used well, intersperse code, commentary, and output, which is one of the best ways of observing the correctness of a job.</p>
<p>On a job, there are three particular things I always monitor.</p>
<p>The first is the quality of data joins. Based on the number of rows (or unique ids), you know how many rows should be in the data set after a join. Checking that the joined data matches expectations can reveal many data quality issues just waiting to ruin your day.</p>
<p>The second checking is cross-tabulations before and after recoding a categorical variable. Making sure the recode logic does what you think and that the values coming in aren’t changing over time is always worth the effort.</p>
<p>The last is goodness-of-fit metrics of an ML model in production. There are many, many frameworks and products for monitoring model quality and model drift once your model is in production. I don’t have strong opinions on these other than that you need to use one if you’ve got a model that’s producing results you hope to rely on.</p>
</section>
<section id="observing-operations" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="observing-operations"><span class="header-section-number">4.2</span> Observing Operations</h2>
<p>Now let’s turn to the issue of observing the operational qualities of your code. The operational qualities of your project are things like the system resources its consuming, the number of users, and user interactions just before an error occurred.</p>
<p>The first step to making your app or API observable is to add logging. You may be used to just adding <code>print</code> statements throughout your code. And, honestly, this is far better than nothing. But purpose-built tooling for logging includes ways to apply consistent formats, emit logs in useful ways, and provide visibility into severity of issues.</p>
<p>There are great logging packages in both Python and R. Python’s logging package is standard. There is not a standard logging package in R, but I recommend <a href="https://cran.r-project.org/web/packages/log4r/index.html"><code>{log4r}</code></a>.</p>
<p>These packages – and basically every other logging package – work very similarly. At the outset of your code, you’ll create and parameterize a <em>log session</em> that persists as long as the Python or R session. When your code does something you want to love, you’ll you’ll use the log session to write <em>log statements</em>. When the log statement runs, it creates a <em>log entry</em>.</p>
<p>For example, here’s what logging for an app starting up might look like in Python</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> logging</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># Configure the log object</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>logging.basicConfig(</span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="bu">format</span><span class="op">=</span><span class="st">'</span><span class="sc">%(asctime)s</span><span class="st"> - </span><span class="sc">%(message)s</span><span class="st">'</span>,</span>
<span id="cb1-6"><a href="#cb1-6"></a>    level<span class="op">=</span>logging.INFO</span>
<span id="cb1-7"><a href="#cb1-7"></a>)</span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co"># Log app start</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>logging.info(<span class="st">"App Started"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>And here’s what that looks like using <code>{log4r}</code></p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Configure the log object</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>log <span class="ot">&lt;-</span> log4r<span class="sc">::</span><span class="fu">logger</span>()</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co"># Log app start</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>log4r<span class="sc">::</span><span class="fu">info</span>(log, <span class="st">"App Started"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>When the R or Python interpreter hits either of these lines, it will create a log entry that looks something like this:</p>
<pre><code>2022-11-18 21:57:50 INFO App Started</code></pre>
<p>Like all log entries, this entry has three components:</p>
<ul>
<li><p>The <em>log metadata</em> is data what the logging library automatically includes on every entry. It is configured when you initialize logging. In the example above, the only metadata is the timestamp. Log metadata can include additional information, like which server you’re running on.</p></li>
<li><p>The second component is the <em>log level</em>. The log level indicates the severity of the event you’re logging. In the example above the log level was <code>INFO</code>.</p></li>
<li><p>The last component is the <em>log data</em>, which provides details on the event you want to log – <code>App Started</code> in this case.</p></li>
</ul>
<section id="understanding-log-levels" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="understanding-log-levels"><span class="header-section-number">4.2.1</span> Understanding log levels</h3>
<p>The log level indicates how serious the logged event is. Most logging libraries have 5-7 log levels. As you’re writing statements into your code, you’ll have to think carefully about the appropriate logging level for a given event.</p>
<p>Both the Python <code>{logging}</code> library and <code>{log4r}</code> have five levels from least to most scary:</p>
<ol type="1">
<li><em>Debug</em>: what the code was doing in detail that will only make sense to someone who really knows the code. For example, you might include which function ran and with what arguments in a debug log.</li>
<li><em>Info</em>: something normal happened in the app. Info statements record things like starting and stopping, successfully making database and other connections, and runtime configuration options.</li>
<li><em>Warn/Warning</em>: an unexpected application issue that isn’t fatal. For example, you might include having to retry doing something or noticing that resource usage is high. If something were to go wrong later, these might be helpful breadcrumbs to look at.</li>
<li><em>Error</em>: an issue that will make an operation not work, but that won’t bring down your app. An example might be a user submitting invalid input and the app recovering.</li>
<li><em>Critical</em>: an error so big that the app itself shuts down. This is the SOS your app sends as it shuts down. For example, if your app cannot run without a connection to an outside service, you might log an inability to connect as a Critical error.</li>
</ol>
<p>When you initialize your logging session, you’ll set your log level, which is the <strong>least critical</strong> level you want to see in the session. In development, you probably want to log everything down to the debug level, while that probably isn’t ideal in prod.</p>
</section>
<section id="configuring-log-formats-and-log-handling" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="configuring-log-formats-and-log-handling"><span class="header-section-number">4.2.2</span> Configuring log formats and log handling</h3>
<p>When you initialize your logging session, you’ll choose where logs will be written and in what format. You’ll configure the format with a <em>formatter</em> or <em>layout</em> and where it goes with a <em>handler</em> or an <em>appender</em>.</p>
<p>For most logging frameworks, the default is to emit logs to the <em>console</em> in <em>plain text</em>.</p>
<p>For example, a plain text log of an app starting might put this on your console</p>
<pre><code>2022-11-18 21:57:50 INFO App Started</code></pre>
<p>You’ll decide the format of your log based on how you’re planning to consume them.</p>
<p>Plain text logs is a great choice if humans are going to be directly reading them. If you’re shipping your logs off to an aggregation service, you might prefer to have structured logs.</p>
<p>The most common structured logging format is JSON, though YAML and XML are often options. If you used JSON logging, the same record might be emitted as</p>
<pre><code>{
  "time": "2022-11-18 21:57:50",
  "level": "INFO", 
  "data": "App Started"
}</code></pre>
<p>Where your logs go should be determined by where your code is running.</p>
<p>In development, printing logs for the console makes it easy to iterate quickly.</p>
<p>In production, the most common way to handle logs is to append them to a file. It makes them easy for humans to access and many tools for aggregating and consuming logs are comfortable watching a file and aggregating lines as they are written.</p>
<p>If you are emitting logs to file, you may also want to consider how long those logs stay around.</p>
<p><em>Log rotation</em> is the process of periodically creating new log files, storing old logs for a set retention period, and deleting files outside that period. A common log rotation pattern is to have a log file that lasts for 24 hours, is retained for 30 days, and is then deleted.</p>
<p>The Python <code>{logging}</code> library does log rotation itself. <code>{log4r}</code> does not, but there is a Linux library called <code>logrotate</code> that you can use in concert with <code>{log4r}</code>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>If you’re running in a Docker container you don’t want to write to a file on disk. As you’ll learn more about in <a href="../sec2/2-4-docker.html">Chapter&nbsp;<span>9</span></a>, anything that lives inside a Docker container is ephemeral. This is obviously bad if you’re writing a log that might contain clues for why a Docker container was unexpectedly killed.</p>
<p>In that case, it’s common practice for a service running in a container to emit logs inside the container and then have some sort of more permanent service collecting the logs outside. This is usually accomplished by sending normal operating logs to go to <em>stdout</em> (usually pronounced standard out) and failures to go to <em>stderr</em> (standard error).</p>
<p>It’s also possible you want to do something else completely custom with your logs. This is most common for critical or error logs. For example, you may want to send an email, slack, or text message immediately if your system emits a high-level log message.</p>
<p>It’s also very common to have different format and location settings in development vs in production. The most common way to enable different logging configurations in different environments is with config files and environment variables. More on how to use these tools in <a href="1-1-env-as-code.html">Chapter&nbsp;<span>1</span></a>.</p>
</section>
<section id="working-with-metrics" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="working-with-metrics"><span class="header-section-number">4.2.3</span> Working with Metrics</h3>
<p>The most common place to see metrics in a data science context is when deploying and monitoring ML models in production. Additionally, monitoring ETL data quality is ripe for more monitoring.</p>
<p>If you are going to configure metrics emission or consumption, most modern metrics stacks are built around the open source tools <em>Prometheus</em> and <em>Grafana</em>.</p>
<p><a href="https://prometheus.io/">Prometheus</a> is an open source monitoring tool that makes it easy to store metrics data, query that data, and alert based on it. <a href="https://grafana.com/">Grafana</a> is an open source dashboarding tool that sits on top of Prometheus to do visualization of the metrics. They are usually used together to do monitoring and visualization of metrics.</p>
<p>You can run Prometheus and Grafana yourself, but Grafana Labs provides a generous free tier for their SaaS service. This is great because you can just set up their service and point your app to it.</p>
<p>Because the Prometheus/Grafana stack started out in the DevOps world, they are most optimized to do monitoring of a whole server or fleet of servers – but it’s not hard to use them to monitor things you might care about like data quality, API response times, or other things.</p>
<p>If you want to register metrics from your API or app with Prometheus, there is an official <a href="https://github.com/prometheus/client_python">Prometheus client</a> in Python and the <code>{openmetrics}</code> package in R makes it easy to register metrics from a Plumber API or Shiny app.</p>
<p>There’s a great <a href="https://grafana.com/docs/grafana/latest/getting-started/get-started-grafana-prometheus/">Get Started with Grafana and Prometheus</a> doc on the Grafana Labs website if you want to actually try it out.</p>
</section>
</section>
<section id="comprehension-questions" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="comprehension-questions"><span class="header-section-number">4.3</span> Comprehension Questions</h2>
<ol type="1">
<li>What is the difference between monitoring and logging? What are the two halves of the monitoring and logging process?</li>
<li>In general, logging is good, but what are some things you should be careful <em>not to log</em>?</li>
<li>At what level would you log each of the following events:
<ol type="1">
<li><p>Someone clicks on a particular tab in your Shiny app.</p></li>
<li><p>Someone puts an invalid entry into a text entry box.</p></li>
<li><p>An <code>http</code> call your app makes to an external API fails.</p></li>
<li><p>The numeric values that are going into your computational function.</p></li>
</ol></li>
</ol>
</section>
<section id="lab-4-an-app-with-logging" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="lab-4-an-app-with-logging"><span class="header-section-number">4.4</span> Lab 4: An App with Logging</h2>
<p>Let’s go back to the prediction generator app from the last lab and add a little logging. This is quite easy in both R and Python. In both, we just declare that we’re using the logger and then we put logging statements into our code.</p>
<p>I decided to log when the app starts, just before and after each request, and an error logger if an HTTP error code comes back from the API.</p>
<p>With the logging now added, here’s what the app looks like in R:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.R</strong></pre>
</div>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">library</span>(shiny)</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a>api_url <span class="ot">&lt;-</span> <span class="st">"http://127.0.0.1:8080/predict"</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>log <span class="ot">&lt;-</span> log4r<span class="sc">::</span><span class="fu">logger</span>()</span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb6-7"><a href="#cb6-7"></a>  <span class="fu">titlePanel</span>(<span class="st">"Penguin Mass Predictor"</span>),</span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="co"># Model input values</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="fu">sidebarLayout</span>(</span>
<span id="cb6-11"><a href="#cb6-11"></a>    <span class="fu">sidebarPanel</span>(</span>
<span id="cb6-12"><a href="#cb6-12"></a>      <span class="fu">sliderInput</span>(</span>
<span id="cb6-13"><a href="#cb6-13"></a>        <span class="st">"bill_length"</span>,</span>
<span id="cb6-14"><a href="#cb6-14"></a>        <span class="st">"Bill Length (mm)"</span>,</span>
<span id="cb6-15"><a href="#cb6-15"></a>        <span class="at">min =</span> <span class="dv">30</span>,</span>
<span id="cb6-16"><a href="#cb6-16"></a>        <span class="at">max =</span> <span class="dv">60</span>,</span>
<span id="cb6-17"><a href="#cb6-17"></a>        <span class="at">value =</span> <span class="dv">45</span>,</span>
<span id="cb6-18"><a href="#cb6-18"></a>        <span class="at">step =</span> <span class="fl">0.1</span></span>
<span id="cb6-19"><a href="#cb6-19"></a>      ),</span>
<span id="cb6-20"><a href="#cb6-20"></a>      <span class="fu">selectInput</span>(</span>
<span id="cb6-21"><a href="#cb6-21"></a>        <span class="st">"sex"</span>,</span>
<span id="cb6-22"><a href="#cb6-22"></a>        <span class="st">"Sex"</span>,</span>
<span id="cb6-23"><a href="#cb6-23"></a>        <span class="fu">c</span>(<span class="st">"Male"</span>, <span class="st">"Female"</span>)</span>
<span id="cb6-24"><a href="#cb6-24"></a>      ),</span>
<span id="cb6-25"><a href="#cb6-25"></a>      <span class="fu">selectInput</span>(</span>
<span id="cb6-26"><a href="#cb6-26"></a>        <span class="st">"species"</span>,</span>
<span id="cb6-27"><a href="#cb6-27"></a>        <span class="st">"Species"</span>,</span>
<span id="cb6-28"><a href="#cb6-28"></a>        <span class="fu">c</span>(<span class="st">"Adelie"</span>, <span class="st">"Chinstrap"</span>, <span class="st">"Gentoo"</span>)</span>
<span id="cb6-29"><a href="#cb6-29"></a>      ),</span>
<span id="cb6-30"><a href="#cb6-30"></a>      <span class="co"># Get model predictions</span></span>
<span id="cb6-31"><a href="#cb6-31"></a>      <span class="fu">actionButton</span>(</span>
<span id="cb6-32"><a href="#cb6-32"></a>        <span class="st">"predict"</span>,</span>
<span id="cb6-33"><a href="#cb6-33"></a>        <span class="st">"Predict"</span></span>
<span id="cb6-34"><a href="#cb6-34"></a>      )</span>
<span id="cb6-35"><a href="#cb6-35"></a>    ),</span>
<span id="cb6-36"><a href="#cb6-36"></a></span>
<span id="cb6-37"><a href="#cb6-37"></a>    <span class="fu">mainPanel</span>(</span>
<span id="cb6-38"><a href="#cb6-38"></a>      <span class="fu">h2</span>(<span class="st">"Penguin Parameters"</span>),</span>
<span id="cb6-39"><a href="#cb6-39"></a>      <span class="fu">verbatimTextOutput</span>(<span class="st">"vals"</span>),</span>
<span id="cb6-40"><a href="#cb6-40"></a>      <span class="fu">h2</span>(<span class="st">"Predicted Penguin Mass (g)"</span>),</span>
<span id="cb6-41"><a href="#cb6-41"></a>      <span class="fu">textOutput</span>(<span class="st">"pred"</span>)</span>
<span id="cb6-42"><a href="#cb6-42"></a>    )</span>
<span id="cb6-43"><a href="#cb6-43"></a>  )</span>
<span id="cb6-44"><a href="#cb6-44"></a>)</span>
<span id="cb6-45"><a href="#cb6-45"></a></span>
<span id="cb6-46"><a href="#cb6-46"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output) {</span>
<span id="cb6-47"><a href="#cb6-47"></a>  log4r<span class="sc">::</span><span class="fu">info</span>(log, <span class="st">"App Started"</span>)</span>
<span id="cb6-48"><a href="#cb6-48"></a>  <span class="co"># Input params</span></span>
<span id="cb6-49"><a href="#cb6-49"></a>  vals <span class="ot">&lt;-</span> <span class="fu">reactive</span>(</span>
<span id="cb6-50"><a href="#cb6-50"></a>    <span class="fu">list</span>(</span>
<span id="cb6-51"><a href="#cb6-51"></a>      <span class="at">bill_length_mm =</span> input<span class="sc">$</span>bill_length,</span>
<span id="cb6-52"><a href="#cb6-52"></a>      <span class="at">species_Chinstrap =</span> input<span class="sc">$</span>species <span class="sc">==</span> <span class="st">"Chinstrap"</span>,</span>
<span id="cb6-53"><a href="#cb6-53"></a>      <span class="at">species_Gentoo =</span> input<span class="sc">$</span>species <span class="sc">==</span> <span class="st">"Gentoo"</span>,</span>
<span id="cb6-54"><a href="#cb6-54"></a>      <span class="at">sex_male =</span> input<span class="sc">$</span>sex <span class="sc">==</span> <span class="st">"Male"</span></span>
<span id="cb6-55"><a href="#cb6-55"></a>    )</span>
<span id="cb6-56"><a href="#cb6-56"></a>  )</span>
<span id="cb6-57"><a href="#cb6-57"></a></span>
<span id="cb6-58"><a href="#cb6-58"></a>  <span class="co"># Fetch prediction from API</span></span>
<span id="cb6-59"><a href="#cb6-59"></a>  pred <span class="ot">&lt;-</span> <span class="fu">eventReactive</span>(</span>
<span id="cb6-60"><a href="#cb6-60"></a>    input<span class="sc">$</span>predict,</span>
<span id="cb6-61"><a href="#cb6-61"></a>    {</span>
<span id="cb6-62"><a href="#cb6-62"></a>      log4r<span class="sc">::</span><span class="fu">info</span>(log, <span class="st">"Prediction Requested"</span>)</span>
<span id="cb6-63"><a href="#cb6-63"></a>      r <span class="ot">&lt;-</span> httr2<span class="sc">::</span><span class="fu">request</span>(api_url) <span class="sc">|&gt;</span></span>
<span id="cb6-64"><a href="#cb6-64"></a>        httr2<span class="sc">::</span><span class="fu">req_body_json</span>(<span class="fu">vals</span>()) <span class="sc">|&gt;</span></span>
<span id="cb6-65"><a href="#cb6-65"></a>        httr2<span class="sc">::</span><span class="fu">req_perform</span>()</span>
<span id="cb6-66"><a href="#cb6-66"></a>      log4r<span class="sc">::</span><span class="fu">info</span>(log, <span class="st">"Prediction Returned"</span>)</span>
<span id="cb6-67"><a href="#cb6-67"></a></span>
<span id="cb6-68"><a href="#cb6-68"></a>      <span class="cf">if</span> (httr2<span class="sc">::</span><span class="fu">resp_is_error</span>(r)) {</span>
<span id="cb6-69"><a href="#cb6-69"></a>        log4r<span class="sc">::</span><span class="fu">error</span>(log, <span class="fu">paste</span>(<span class="st">"HTTP Error"</span>))</span>
<span id="cb6-70"><a href="#cb6-70"></a>      }</span>
<span id="cb6-71"><a href="#cb6-71"></a></span>
<span id="cb6-72"><a href="#cb6-72"></a>      httr2<span class="sc">::</span><span class="fu">resp_body_json</span>(r)</span>
<span id="cb6-73"><a href="#cb6-73"></a>    },</span>
<span id="cb6-74"><a href="#cb6-74"></a>    <span class="at">ignoreInit =</span> <span class="cn">TRUE</span></span>
<span id="cb6-75"><a href="#cb6-75"></a>  )</span>
<span id="cb6-76"><a href="#cb6-76"></a></span>
<span id="cb6-77"><a href="#cb6-77"></a>  <span class="co"># Render to UI</span></span>
<span id="cb6-78"><a href="#cb6-78"></a>  output<span class="sc">$</span>pred <span class="ot">&lt;-</span> <span class="fu">renderText</span>(<span class="fu">pred</span>()<span class="sc">$</span>predict[[<span class="dv">1</span>]])</span>
<span id="cb6-79"><a href="#cb6-79"></a>  output<span class="sc">$</span>vals <span class="ot">&lt;-</span> <span class="fu">renderPrint</span>(<span class="fu">vals</span>())</span>
<span id="cb6-80"><a href="#cb6-80"></a>}</span>
<span id="cb6-81"><a href="#cb6-81"></a></span>
<span id="cb6-82"><a href="#cb6-82"></a><span class="co"># Run the application</span></span>
<span id="cb6-83"><a href="#cb6-83"></a><span class="fu">shinyApp</span>(<span class="at">ui =</span> ui, <span class="at">server =</span> server)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And in Python:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app.py</strong></pre>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="im">from</span> shiny <span class="im">import</span> App, render, ui, reactive</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="im">import</span> requests</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="im">import</span> logging</span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a>api_url <span class="op">=</span> <span class="st">'http://127.0.0.1:8080/predict'</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>logging.basicConfig(</span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="bu">format</span><span class="op">=</span><span class="st">'</span><span class="sc">%(asctime)s</span><span class="st"> - </span><span class="sc">%(message)s</span><span class="st">'</span>,</span>
<span id="cb7-8"><a href="#cb7-8"></a>    level<span class="op">=</span>logging.INFO</span>
<span id="cb7-9"><a href="#cb7-9"></a>)</span>
<span id="cb7-10"><a href="#cb7-10"></a></span>
<span id="cb7-11"><a href="#cb7-11"></a>app_ui <span class="op">=</span> ui.page_fluid(</span>
<span id="cb7-12"><a href="#cb7-12"></a>    ui.panel_title(<span class="st">"Penguin Mass Predictor"</span>), </span>
<span id="cb7-13"><a href="#cb7-13"></a>    ui.layout_sidebar(</span>
<span id="cb7-14"><a href="#cb7-14"></a>        ui.panel_sidebar(</span>
<span id="cb7-15"><a href="#cb7-15"></a>            [ui.input_slider(<span class="st">"bill_length"</span>, <span class="st">"Bill Length (mm)"</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">45</span>, step <span class="op">=</span> <span class="fl">0.1</span>),</span>
<span id="cb7-16"><a href="#cb7-16"></a>            ui.input_select(<span class="st">"sex"</span>, <span class="st">"Sex"</span>, [<span class="st">"Male"</span>, <span class="st">"Female"</span>]),</span>
<span id="cb7-17"><a href="#cb7-17"></a>            ui.input_select(<span class="st">"species"</span>, <span class="st">"Species"</span>, [<span class="st">"Adelie"</span>, <span class="st">"Chinstrap"</span>, <span class="st">"Gentoo"</span>]),</span>
<span id="cb7-18"><a href="#cb7-18"></a>            ui.input_action_button(<span class="st">"predict"</span>, <span class="st">"Predict"</span>)]</span>
<span id="cb7-19"><a href="#cb7-19"></a>        ),</span>
<span id="cb7-20"><a href="#cb7-20"></a>        ui.panel_main(</span>
<span id="cb7-21"><a href="#cb7-21"></a>            ui.h2(<span class="st">"Penguin Parameters"</span>),</span>
<span id="cb7-22"><a href="#cb7-22"></a>            ui.output_text_verbatim(<span class="st">"vals_out"</span>),</span>
<span id="cb7-23"><a href="#cb7-23"></a>            ui.h2(<span class="st">"Predicted Penguin Mass (g)"</span>), </span>
<span id="cb7-24"><a href="#cb7-24"></a>            ui.output_text(<span class="st">"pred_out"</span>)</span>
<span id="cb7-25"><a href="#cb7-25"></a>        )</span>
<span id="cb7-26"><a href="#cb7-26"></a>    )   </span>
<span id="cb7-27"><a href="#cb7-27"></a>)</span>
<span id="cb7-28"><a href="#cb7-28"></a></span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="kw">def</span> server(<span class="bu">input</span>, output, session):</span>
<span id="cb7-30"><a href="#cb7-30"></a>    logging.info(<span class="st">"App start"</span>)</span>
<span id="cb7-31"><a href="#cb7-31"></a></span>
<span id="cb7-32"><a href="#cb7-32"></a>    <span class="at">@reactive.Calc</span></span>
<span id="cb7-33"><a href="#cb7-33"></a>    <span class="kw">def</span> vals():</span>
<span id="cb7-34"><a href="#cb7-34"></a>        d <span class="op">=</span> {</span>
<span id="cb7-35"><a href="#cb7-35"></a>            <span class="st">"bill_length_mm"</span> : <span class="bu">input</span>.bill_length(),</span>
<span id="cb7-36"><a href="#cb7-36"></a>            <span class="st">"sex_Male"</span> : <span class="bu">input</span>.sex() <span class="op">==</span> <span class="st">"Male"</span>,</span>
<span id="cb7-37"><a href="#cb7-37"></a>            <span class="st">"species_Gentoo"</span> : <span class="bu">input</span>.species() <span class="op">==</span> <span class="st">"Gentoo"</span>, </span>
<span id="cb7-38"><a href="#cb7-38"></a>            <span class="st">"species_Chinstrap"</span> : <span class="bu">input</span>.species() <span class="op">==</span> <span class="st">"Chinstrap"</span></span>
<span id="cb7-39"><a href="#cb7-39"></a></span>
<span id="cb7-40"><a href="#cb7-40"></a>        }</span>
<span id="cb7-41"><a href="#cb7-41"></a>        <span class="cf">return</span> d</span>
<span id="cb7-42"><a href="#cb7-42"></a>    </span>
<span id="cb7-43"><a href="#cb7-43"></a>    <span class="at">@reactive.Calc</span></span>
<span id="cb7-44"><a href="#cb7-44"></a>    <span class="at">@reactive.event</span>(<span class="bu">input</span>.predict)</span>
<span id="cb7-45"><a href="#cb7-45"></a>    <span class="kw">def</span> pred():</span>
<span id="cb7-46"><a href="#cb7-46"></a>        logging.info(<span class="st">"Request Made"</span>)</span>
<span id="cb7-47"><a href="#cb7-47"></a>        r <span class="op">=</span> requests.post(api_url, json <span class="op">=</span> vals())</span>
<span id="cb7-48"><a href="#cb7-48"></a>        logging.info(<span class="st">"Request Returned"</span>)</span>
<span id="cb7-49"><a href="#cb7-49"></a></span>
<span id="cb7-50"><a href="#cb7-50"></a>        <span class="cf">if</span> r.status_code <span class="op">!=</span> <span class="dv">200</span>:</span>
<span id="cb7-51"><a href="#cb7-51"></a>            logging.error(<span class="st">"HTTP error returned"</span>)</span>
<span id="cb7-52"><a href="#cb7-52"></a></span>
<span id="cb7-53"><a href="#cb7-53"></a>        <span class="cf">return</span> r.json().get(<span class="st">'predict'</span>)[<span class="dv">0</span>]</span>
<span id="cb7-54"><a href="#cb7-54"></a></span>
<span id="cb7-55"><a href="#cb7-55"></a>    <span class="at">@output</span></span>
<span id="cb7-56"><a href="#cb7-56"></a>    <span class="at">@render.text</span></span>
<span id="cb7-57"><a href="#cb7-57"></a>    <span class="kw">def</span> vals_out():</span>
<span id="cb7-58"><a href="#cb7-58"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>vals()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb7-59"><a href="#cb7-59"></a></span>
<span id="cb7-60"><a href="#cb7-60"></a>    <span class="at">@output</span></span>
<span id="cb7-61"><a href="#cb7-61"></a>    <span class="at">@render.text</span></span>
<span id="cb7-62"><a href="#cb7-62"></a>    <span class="kw">def</span> pred_out():</span>
<span id="cb7-63"><a href="#cb7-63"></a>        <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span><span class="bu">round</span>(pred())<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb7-64"><a href="#cb7-64"></a></span>
<span id="cb7-65"><a href="#cb7-65"></a>app <span class="op">=</span> App(app_ui, server)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, if you load up this app locally, you can see the logs of what’s happening stream in as you’re pressing buttons in the app.</p>
<p>You can feel free to log whatever you think is helpful – for example, it’d probably be more useful to get the actual error contents if an HTTP error comes back.</p>


</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>There are two common naming patterns with rotating log files.</p>
<p>The first is to have dated log filenames that look like <code>my-log-20221118.log</code>.</p>
<p>The other pattern is to keep one file that’s current and have the older ones numbered. So today’s log would be <code>my-log.log</code>, yesterday’s would be <code>my-log.log.1</code> , the day before <code>my-log.log.2</code>, etc. This second pattern works particularly well if you’re using <code>logrotate</code> with <code>log4r</code>, because then <code>log4r</code> doesn’t need to know anything about the log rotation. It’s just always writing to <code>my-log.log</code>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../chapters/sec1/1-3-data-access.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Using databases and data APIs</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../chapters/sec1/1-5-deployments.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Deployments and code promotion</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, Alex K Gold</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link active" href="https://github.com/akgold/do4ds" aria-current="page">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/alexkgold">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>