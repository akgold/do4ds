<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DevOps for Data Science - 3&nbsp; Data Science Project Architecture</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../chapters/sec1/1-4-monitor-log.html" rel="next">
<link href="../../chapters/sec1/1-2-env-as-code.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BTSMMRMH08"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BTSMMRMH08', { 'anonymize_ip': true});
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data Science Project Architecture</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">DevOps for Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/akgold/do4ds" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">Welcome!</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/intro.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec1/1-0-sec-intro.html" class="sidebar-item-text sidebar-link">DevOps Lessons for Data Science</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-1-code-promotion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Code promotion and integration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-2-env-as-code.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Environments as Code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-3-proj-components.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data Science Project Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-4-monitor-log.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Logging and Monitoring</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-5-docker.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Docker for Data Science</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec2/2-0-sec-intro.html" class="sidebar-item-text sidebar-link">The DIY Data Science Environment</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-1-cloud.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Getting Started with the Cloud</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-2-cmd-line.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">The Command Line + SSH</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-3-linux-admin.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Administering a Linux Server</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-4-understanding-traffic.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Computer Networks and the Internet</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-5-servers.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Choosing the right server for you</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec3/3-0-sec-intro.html" class="sidebar-item-text sidebar-link">Making it Enterprise-Grade</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-1-os-ds-in-ent.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Open Source Data Science in the Enterprise</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-2-secure-networking.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Upgraded Networking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-3-auth.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Logging in with auth</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-4-scaling.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Scaling</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/append/docker-cheatsheet.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Docker Cheatsheet</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-three-layer-app" id="toc-the-three-layer-app" class="nav-link active" data-scroll-target="#the-three-layer-app"><span class="toc-section-number">3.1</span>  The three-layer app</a></li>
  <li><a href="#separate-business-and-interaction-logic" id="toc-separate-business-and-interaction-logic" class="nav-link" data-scroll-target="#separate-business-and-interaction-logic"><span class="toc-section-number">3.2</span>  Separate business and interaction logic</a>
  <ul class="collapse">
  <li><a href="#consider-using-an-api-for-long-running-processes" id="toc-consider-using-an-api-for-long-running-processes" class="nav-link" data-scroll-target="#consider-using-an-api-for-long-running-processes"><span class="toc-section-number">3.2.1</span>  Consider using an API for long-running processes</a></li>
  </ul></li>
  <li><a href="#separate-data-from-app" id="toc-separate-data-from-app" class="nav-link" data-scroll-target="#separate-data-from-app"><span class="toc-section-number">3.3</span>  Separate data from app</a>
  <ul class="collapse">
  <li><a href="#storage-format" id="toc-storage-format" class="nav-link" data-scroll-target="#storage-format"><span class="toc-section-number">3.3.1</span>  Storage Format</a></li>
  <li><a href="#storage-location" id="toc-storage-location" class="nav-link" data-scroll-target="#storage-location"><span class="toc-section-number">3.3.2</span>  Storage Location</a></li>
  </ul></li>
  <li><a href="#choosing-your-storage-solution" id="toc-choosing-your-storage-solution" class="nav-link" data-scroll-target="#choosing-your-storage-solution"><span class="toc-section-number">3.4</span>  Choosing your storage solution</a>
  <ul class="collapse">
  <li><a href="#how-frequently-are-the-data-updated-relative-to-the-code" id="toc-how-frequently-are-the-data-updated-relative-to-the-code" class="nav-link" data-scroll-target="#how-frequently-are-the-data-updated-relative-to-the-code"><span class="toc-section-number">3.4.1</span>  How frequently are the data updated relative to the code?</a></li>
  <li><a href="#is-your-app-read-only-or-does-it-have-to-write" id="toc-is-your-app-read-only-or-does-it-have-to-write" class="nav-link" data-scroll-target="#is-your-app-read-only-or-does-it-have-to-write"><span class="toc-section-number">3.4.2</span>  Is your app read-only, or does it have to write?</a></li>
  </ul></li>
  <li><a href="#when-does-the-app-fetch-its-data" id="toc-when-does-the-app-fetch-its-data" class="nav-link" data-scroll-target="#when-does-the-app-fetch-its-data"><span class="toc-section-number">3.5</span>  When does the app fetch its data?</a>
  <ul class="collapse">
  <li><a href="#how-big-are-the-data-in-the-app" id="toc-how-big-are-the-data-in-the-app" class="nav-link" data-scroll-target="#how-big-are-the-data-in-the-app"><span class="toc-section-number">3.5.1</span>  How big are the data in the app?</a></li>
  <li><a href="#what-are-the-performance-requirements-for-the-app" id="toc-what-are-the-performance-requirements-for-the-app" class="nav-link" data-scroll-target="#what-are-the-performance-requirements-for-the-app"><span class="toc-section-number">3.5.2</span>  What are the performance requirements for the app?</a></li>
  <li><a href="#creating-performant-database-queries" id="toc-creating-performant-database-queries" class="nav-link" data-scroll-target="#creating-performant-database-queries"><span class="toc-section-number">3.5.3</span>  Creating Performant Database Queries</a></li>
  <li><a href="#how-to-connect-to-databases" id="toc-how-to-connect-to-databases" class="nav-link" data-scroll-target="#how-to-connect-to-databases"><span class="toc-section-number">3.5.4</span>  How to connect to databases?</a></li>
  </ul></li>
  <li><a href="#how-do-i-do-data-authorization" id="toc-how-do-i-do-data-authorization" class="nav-link" data-scroll-target="#how-do-i-do-data-authorization"><span class="toc-section-number">3.6</span>  How do I do data authorization?</a>
  <ul class="collapse">
  <li><a href="#securely-managing-credentials" id="toc-securely-managing-credentials" class="nav-link" data-scroll-target="#securely-managing-credentials"><span class="toc-section-number">3.6.1</span>  Securely Managing Credentials</a></li>
  </ul></li>
  <li><a href="#comprehension-questions" id="toc-comprehension-questions" class="nav-link" data-scroll-target="#comprehension-questions"><span class="toc-section-number">3.7</span>  Comprehension Questions</a></li>
  <li><a href="#portfolio-exercise-standing-up-a-loosely-coupled-app" id="toc-portfolio-exercise-standing-up-a-loosely-coupled-app" class="nav-link" data-scroll-target="#portfolio-exercise-standing-up-a-loosely-coupled-app"><span class="toc-section-number">3.8</span>  Portfolio Exercise: Standing Up a Loosely Coupled App</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/akgold/do4ds/edit/main/chapters/sec1/1-3-proj-components.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-project-arch" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data Science Project Architecture</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>As a data scientist, you’re probably well familiar with the concept of functions in your chosen programming language. The advantage of functions is that once you’ve written one, you can focus exclusively on what’s happening inside the function. When you’re not, you can logically abstract away what the function does and just assume that you’ll write a function to do that thing.</p>
<p>You should be thinking similarly about the architecture of your data science project.</p>
<p>As you’re building out your app, report, or API, you should be thinking about how to architect your project so that you can do updates in the future in a way that is painless. You want to modularize your app so that you can apply the other best practices in this book – like using CI/CD easily and painlessly.</p>
<p>In short, this chapter will be about how to take the software engineering notion of a three-layer app architecture and apply it to your data science project. We’ll get into what the layers should be, how to decide on a boundary point between them, and how to configure each piece to work with the others.</p>
<section id="the-three-layer-app" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="the-three-layer-app"><span class="header-section-number">3.1</span> The three-layer app</h2>
<p>The three-layer app architecture is the most common software architecture that exists in the world today.</p>
<p>A three-layer app consists, unsurprisingly, of three parts:</p>
<ul>
<li><p>Presentation/Interaction layer – the layer where users actually interact.</p></li>
<li><p>Application layer – processes data and does the actual work of the app.</p></li>
<li><p>Data layer – the layer that stores data for the app.</p></li>
</ul>
<p>If you’ve heard the terms front-end and back-end, front-end roughly corresponds to the presentation layer, and back-end to application and data layers.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Is three-layer dead?
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you’re looking around on the internet, you may see assertions that the three-layer app is dead and architectures are moving to microservices or other architectures. In my observation, this is overhyped, and many data science projects would do well to move to a three-layer architecture.</p>
</div>
</div>
<p>The hardest part of building a three-layer app is understanding what goes in each tier and how to draw the boundaries. In this chapter, I’ll introduce two rules of production app creation:</p>
<p>Separate your business logic from app logic</p>
<p>Separate your data from the app</p>
<p>These roughly correspond to the boundaries between the presentation and application layer, and between the application and data layers.</p>
</section>
<section id="separate-business-and-interaction-logic" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="separate-business-and-interaction-logic"><span class="header-section-number">3.2</span> Separate business and interaction logic</h2>
<p>There are great frameworks for writing apps in both R and Python – there’s Streamlit, Dash, and Shiny in Python and Shiny in R. This advice also applies if you’re creating a report or some kind of static document using a Jupyter Notebook, R Markdown, or Quarto.</p>
<p>Regardless of the framework you’re using to create your project, it’s important to separate the business and the interaction logic.</p>
<p>What does this mean?</p>
<p>All too often, I see monolithic Shiny apps of thousands or tens of thousands of lines of code, with button definitions, UI bits, and user interaction definitions mixed in among the actual work of the app. There are two reasons this doesn’t work particularly well.</p>
<p>It’s much easier to read through your app or report code and understand what it’s doing when the app itself is only concerned with displaying UI elements to the user, passing choices and actions to the backend, and then displaying the result back to the user.</p>
<p>The application tier is where your business logic should live. The business logic is that actual work that the application does. For a data science app, this is often slicing and dicing data, computing statistics on that data, generating model predictions, and constructing plots.</p>
<p>Separating presentation from business layers means that you want to encapsulate the business logic somehow so that you can work on how the business logic works independently from changing the way users might interact with the app. For example, this might mean creating standalone functions to write plots or create statistics.</p>
<p>If you’re using Shiny, R Markdown, or Quarto, this will mean passing values to those functions that are no longer reactive and that have been generated from input parameters.</p>
<p>Let’s start with a counterexample. Here’s a simple app in Shiny for R that visualizes certain data points from the Palmer Penguins data set. This is an example of bad app architecture.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(palmerpenguins)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(shiny)</span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a>all_penguins <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Adelie"</span>, <span class="st">"Chinstrap"</span>, <span class="st">"Gentoo"</span>)</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># Define UI</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="fu">sidebarLayout</span>(</span>
<span id="cb1-11"><a href="#cb1-11"></a>    <span class="fu">sidebarPanel</span>(</span>
<span id="cb1-12"><a href="#cb1-12"></a>      <span class="co"># Select which species to include</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>      <span class="fu">selectInput</span>(</span>
<span id="cb1-14"><a href="#cb1-14"></a>        <span class="at">inputId =</span> <span class="st">"species"</span>, </span>
<span id="cb1-15"><a href="#cb1-15"></a>        <span class="at">label =</span> <span class="st">"Species"</span>, </span>
<span id="cb1-16"><a href="#cb1-16"></a>        <span class="at">choices =</span> all_penguins, </span>
<span id="cb1-17"><a href="#cb1-17"></a>        <span class="at">selected =</span> all_penguins,</span>
<span id="cb1-18"><a href="#cb1-18"></a>        <span class="at">multiple =</span> <span class="cn">TRUE</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>      )</span>
<span id="cb1-20"><a href="#cb1-20"></a>    ),</span>
<span id="cb1-21"><a href="#cb1-21"></a>    <span class="co"># Show a plot of penguin data</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>    <span class="fu">mainPanel</span>(</span>
<span id="cb1-23"><a href="#cb1-23"></a>      <span class="fu">plotOutput</span>(<span class="st">"penguinPlot"</span>)</span>
<span id="cb1-24"><a href="#cb1-24"></a>    )</span>
<span id="cb1-25"><a href="#cb1-25"></a>  )</span>
<span id="cb1-26"><a href="#cb1-26"></a>)</span>
<span id="cb1-27"><a href="#cb1-27"></a></span>
<span id="cb1-28"><a href="#cb1-28"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output) {</span>
<span id="cb1-29"><a href="#cb1-29"></a>  </span>
<span id="cb1-30"><a href="#cb1-30"></a>  output<span class="sc">$</span>penguinPlot <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>({</span>
<span id="cb1-31"><a href="#cb1-31"></a>    <span class="co"># Filter data</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>    dat <span class="ot">&lt;-</span> palmerpenguins<span class="sc">::</span>penguins <span class="sc">%&gt;%</span></span>
<span id="cb1-33"><a href="#cb1-33"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb1-34"><a href="#cb1-34"></a>        species <span class="sc">%in%</span> input<span class="sc">$</span>species</span>
<span id="cb1-35"><a href="#cb1-35"></a>      )</span>
<span id="cb1-36"><a href="#cb1-36"></a>    </span>
<span id="cb1-37"><a href="#cb1-37"></a>    <span class="co"># Render Plot</span></span>
<span id="cb1-38"><a href="#cb1-38"></a>    dat <span class="sc">%&gt;%</span></span>
<span id="cb1-39"><a href="#cb1-39"></a>      <span class="fu">ggplot</span>(</span>
<span id="cb1-40"><a href="#cb1-40"></a>        <span class="fu">aes</span>(</span>
<span id="cb1-41"><a href="#cb1-41"></a>          <span class="at">x =</span> flipper_length_mm,</span>
<span id="cb1-42"><a href="#cb1-42"></a>          <span class="at">y =</span> body_mass_g,</span>
<span id="cb1-43"><a href="#cb1-43"></a>          <span class="at">color =</span> sex</span>
<span id="cb1-44"><a href="#cb1-44"></a>        )</span>
<span id="cb1-45"><a href="#cb1-45"></a>      ) <span class="sc">+</span></span>
<span id="cb1-46"><a href="#cb1-46"></a>      <span class="fu">geom_point</span>()</span>
<span id="cb1-47"><a href="#cb1-47"></a>  })</span>
<span id="cb1-48"><a href="#cb1-48"></a>  </span>
<span id="cb1-49"><a href="#cb1-49"></a>}</span>
<span id="cb1-50"><a href="#cb1-50"></a></span>
<span id="cb1-51"><a href="#cb1-51"></a><span class="co"># Run the application </span></span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="fu">shinyApp</span>(<span class="at">ui =</span> ui, <span class="at">server =</span> server)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The structure of this Shiny app is bad. Now, it’s not a huge deal, because this is a simple Shiny app that’s pretty easy to parse if you are reasonably comfortable with R and Shiny.</p>
<p>Why is this bad? Look at the app’s server block. Because all of the app’s logic is contained inside a single <code>plotRender</code> statement.</p>
<p><code>plotRender</code> is a presentation function – it renders plots. But I’ve got logic in there that generates the data set I need and generates the plot. Again, because this app is simple, it’s not a huge deal here. But imagine if this app had several tabs, multiple input dropdowns, a dozen or more plots, and complicated logic dictating how to process the dropdown choices into the plots. It would be a mess!</p>
<p>Instead, we should separate the presentation logic from the business logic. That is, let’s separate the code for generating the UI, taking the user’s choice of penguin</p>
<p>The business logic – what those decisions mean, and the resulting calculations – should, at minimum, be moved into standalone functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="fu">library</span>(palmerpenguins)</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="fu">library</span>(shiny)</span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a>all_penguins <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Adelie"</span>, <span class="st">"Chinstrap"</span>, <span class="st">"Gentoo"</span>)</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co"># Define UI</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>ui <span class="ot">&lt;-</span> <span class="fu">fluidPage</span>(</span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="fu">sidebarLayout</span>(</span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="fu">sidebarPanel</span>(</span>
<span id="cb2-12"><a href="#cb2-12"></a>      <span class="co"># Select which species to include</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>      <span class="fu">selectInput</span>(</span>
<span id="cb2-14"><a href="#cb2-14"></a>        <span class="at">inputId =</span> <span class="st">"species"</span>, </span>
<span id="cb2-15"><a href="#cb2-15"></a>        <span class="at">label =</span> <span class="st">"Species"</span>, </span>
<span id="cb2-16"><a href="#cb2-16"></a>        <span class="at">choices =</span> all_penguins, </span>
<span id="cb2-17"><a href="#cb2-17"></a>        <span class="at">selected =</span> all_penguins,</span>
<span id="cb2-18"><a href="#cb2-18"></a>        <span class="at">multiple =</span> <span class="cn">TRUE</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>      )</span>
<span id="cb2-20"><a href="#cb2-20"></a>    ),</span>
<span id="cb2-21"><a href="#cb2-21"></a>    <span class="co"># Show a plot of penguin data</span></span>
<span id="cb2-22"><a href="#cb2-22"></a>    <span class="fu">mainPanel</span>(</span>
<span id="cb2-23"><a href="#cb2-23"></a>      <span class="fu">plotOutput</span>(<span class="st">"penguinPlot"</span>)</span>
<span id="cb2-24"><a href="#cb2-24"></a>    )</span>
<span id="cb2-25"><a href="#cb2-25"></a>  )</span>
<span id="cb2-26"><a href="#cb2-26"></a>)</span>
<span id="cb2-27"><a href="#cb2-27"></a></span>
<span id="cb2-28"><a href="#cb2-28"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output) {</span>
<span id="cb2-29"><a href="#cb2-29"></a>  </span>
<span id="cb2-30"><a href="#cb2-30"></a>  <span class="co"># Filter data</span></span>
<span id="cb2-31"><a href="#cb2-31"></a>  dat <span class="ot">&lt;-</span> <span class="fu">reactive</span>(</span>
<span id="cb2-32"><a href="#cb2-32"></a>    <span class="fu">filter_data</span>(input<span class="sc">$</span>species)</span>
<span id="cb2-33"><a href="#cb2-33"></a>    )</span>
<span id="cb2-34"><a href="#cb2-34"></a>  </span>
<span id="cb2-35"><a href="#cb2-35"></a>  <span class="co"># Render Plot</span></span>
<span id="cb2-36"><a href="#cb2-36"></a>  output<span class="sc">$</span>penguinPlot <span class="ot">&lt;-</span> <span class="fu">renderPlot</span>(</span>
<span id="cb2-37"><a href="#cb2-37"></a>    <span class="fu">make_penguin_plot</span>(<span class="fu">dat</span>())</span>
<span id="cb2-38"><a href="#cb2-38"></a>    )</span>
<span id="cb2-39"><a href="#cb2-39"></a>}</span>
<span id="cb2-40"><a href="#cb2-40"></a></span>
<span id="cb2-41"><a href="#cb2-41"></a><span class="co"># Run the application </span></span>
<span id="cb2-42"><a href="#cb2-42"></a><span class="fu">shinyApp</span>(<span class="at">ui =</span> ui, <span class="at">server =</span> server)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now you can see that the app itself had gotten much simpler. The UI hasn’t changed at all, but the server block is now just two lines! And since I used descriptive function names, it’s really easy to understand what happens in each of the places where my app has reactive behavior.</p>
<p>Either in the same file, or in another file I can source in, I can now include the two functions that include my business logic:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">#' Get the penguin data</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">#'</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">#' @param species character, which penguin species</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">#' @return data frame</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">#'</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">#' @examples</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">#' filter_data("Adelie")</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>filter_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">species =</span> <span class="fu">c</span>(<span class="st">"Adelie"</span>, <span class="st">"Chinstrap"</span>, <span class="st">"Gentoo"</span>)) {</span>
<span id="cb3-9"><a href="#cb3-9"></a>  palmerpenguins<span class="sc">::</span>penguins <span class="sc">%&gt;%</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb3-11"><a href="#cb3-11"></a>      species <span class="sc">%in%</span> <span class="sc">!!</span>species</span>
<span id="cb3-12"><a href="#cb3-12"></a>    )</span>
<span id="cb3-13"><a href="#cb3-13"></a>}</span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co">#' Create a plot of the penguin data</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co">#'</span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">#' @param data data frame</span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co">#'</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co">#' @return ggplot object</span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co">#'</span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="co">#' @examples</span></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="co">#' filter_data("Adelie") |&gt; plot_gen()</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>plot_gen <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb3-24"><a href="#cb3-24"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb3-25"><a href="#cb3-25"></a>    <span class="fu">ggplot</span>(</span>
<span id="cb3-26"><a href="#cb3-26"></a>      <span class="fu">aes</span>(</span>
<span id="cb3-27"><a href="#cb3-27"></a>        <span class="at">x =</span> flipper_length_mm,</span>
<span id="cb3-28"><a href="#cb3-28"></a>        <span class="at">y =</span> body_mass_g,</span>
<span id="cb3-29"><a href="#cb3-29"></a>        <span class="at">color =</span> sex</span>
<span id="cb3-30"><a href="#cb3-30"></a>      )</span>
<span id="cb3-31"><a href="#cb3-31"></a>    ) <span class="sc">+</span></span>
<span id="cb3-32"><a href="#cb3-32"></a>    <span class="fu">geom_point</span>()</span>
<span id="cb3-33"><a href="#cb3-33"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that somewhere along the way, I also added function definitions and comments using ROxygen. This isn’t an accident! Writing standalone functions is a great way to force yourself to be clear about what should happen, and writing examples is the first step towards writing tests for your code.</p>
<section id="consider-using-an-api-for-long-running-processes" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="consider-using-an-api-for-long-running-processes"><span class="header-section-number">3.2.1</span> Consider using an API for long-running processes</h3>
<p>In the case of a true three-layer app, it is almost always the case that the middle tier will be an application programming interface (API). In a data science app, separating business logic into functions is often sufficient. But if you’ve got a long-running bit of business logic, it’s often helpful to separate it into an API.</p>
<p>You can basically think of an API as a “function as a service”. That is, an API is just one or more functions, but instead of being called within the same process that your app is running or your report is processing, it will run in a completely separate process.</p>
<p>For example, let’s say you’ve got an app that allows users to feed in input data and then generate a model based on that data. If you generate the model inside the app, the user will have the experience of pressing the button to generate the model and having the app seize up on them while they’re waiting. Moreover, other users of the app will find themselves affected by this behavior.</p>
<p>If, instead, the button in the app ships the long-running process to a separate API, it gives you the ability to think about scaling out the presentation layer separate from the business layer.</p>
<p>Luckily, if you’ve written functions for your app, turning them into an API is trivial.</p>
<p>Let’s take that first function for getting the appropriate data set and turn it into an API using the <code>plumber</code> library in R. The <code>FastAPI</code> library is a popular Python library for writing APIs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">library</span>(plumber)</span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">#* @apiTitle Penguin Explorer</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">#* @apiDescription An API for exploring palmer penguins.</span></span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#* Get data set based on parameters</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#* @param species character, which penguin species</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">#* @get /data</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="cf">function</span>(<span class="at">species =</span> <span class="fu">c</span>(<span class="st">"Adelie"</span>, <span class="st">"Chinstrap"</span>, <span class="st">"Gentoo"</span>)) {</span>
<span id="cb4-10"><a href="#cb4-10"></a>  palmerpenguins<span class="sc">::</span>penguins <span class="sc">%&gt;%</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb4-12"><a href="#cb4-12"></a>      species <span class="sc">%in%</span> <span class="sc">!!</span>species</span>
<span id="cb4-13"><a href="#cb4-13"></a>    )</span>
<span id="cb4-14"><a href="#cb4-14"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You’ll notice that there are no changes to the actual code of the function. The commented lines that provide the function name and arguments are now prefixed by <code>#*</code> rather than <code>#'</code>, and there are a few more arguments, including the type of query this function accepts and the path.</p>
<p>For more on querying APIs and working with paths, see <a href="../sec2/2-4-understanding-traffic.html">Chapter&nbsp;<span>9</span></a>.</p>
<p>I’ll also need to change my function in the app somewhat to actually call the API, but it’s pretty easy using a package like <code>httr2</code> in R or <code>requests</code> in Python.</p>
<p>The easiest way to host an R or Python API is using Docker. See <a href="1-5-docker.html">Chapter&nbsp;<span>5</span></a> for how you would host this example inside a Docker container, or the documentation of the relevant package for other options.</p>
</section>
</section>
<section id="separate-data-from-app" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="separate-data-from-app"><span class="header-section-number">3.3</span> Separate data from app</h2>
<p>Similarly to separating the presentation layer from the application layer, we’ll also want to separate out the data layer. In a data science app, there are two things you’re likely to have in the data layer.</p>
<p>The first is one or more rectangular data frames. A lot of data science projects are dashboards based on existing data. You may need to ingest and clean that data before it goes into the app. You should create standalone jobs to do that before it gets to the actual finished business logic.</p>
<p>The other thing you’re likely to store is a machine learning model. You’ll probably have a separate process to train the machine learning model and have it ready to go.</p>
<p>TODO: Image of two strands of ds project – ML model + rect df</p>
<section id="storage-format" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="storage-format"><span class="header-section-number">3.3.1</span> Storage Format</h3>
<p>The first question of how to store the data is the storage format. There are really three distinct options for storage format.</p>
<p><strong>Flat file</strong> storage describes writing the data out into a simple file. The canonical example of a flat file is a <code>csv</code> file. However, there are also other formats that may make data storage smaller because of compression, make reads faster, and/or allow you to save arbitrary objects rather than just rectangular data. In R, the <code>rds</code> format is the generic binary format, while <code>pickle</code> is the generic binary format in python.</p>
<p>Flat files can be moved around just like any other file on your computer. You can put them on your computer, and share them through tools like dropbox, google drive, scp, or more.</p>
<p>The biggest disadvantage of flat file data storage is twofold – and is related to their indivisibility. In order to use a flat file in R or Python, you’ll need to load it into your R or Python session. For small data files, this isn’t a big deal. But if you’ve got a large file, it can take a long time to read, which you may not want to wait for. Also, if your file has to go over a network, that can be a very slow operation. Or you might have to load it into an app at startup. Also, there’s generally no way to version data, or just update part, so, if you’re saving archival versions, they can take up a lot of space very quickly.</p>
<p>At the other extreme end from a flat file format is a <strong>database</strong>. A database is a standalone server with its own storage, memory, and compute. In general, you’ll recall things from a database using some sort of query language. Most databases you’ll interact with in a data science context are designed around storing rectangular data structures and use Structured Query Language (SQL) to get at the data inside.</p>
<p>There are other sorts of databases that store other kinds of objects – you may need these depending on the kind of objects you’re working with. Often the IT/Admin group will have standard databases they work with or use, and you can just piggyback on their decisions. Sometimes you’ll also have choices to make about what database to use, which are beyond the scope of this book.</p>
<p>The big advantage of a database is that the data is stored and managed by an independent process. This means that accessing data from your app is often a matter of just connecting to the database, as opposed to having to move files around.</p>
<p>Working with databases can also be frought. You usually end up in one of two situations. In the first situation, the database isn’t really for the data science team. You can probably get read access, but not write – so you’ll be able to use the database as your source of truth, but you won’t be able to write there for intermediate tables and other things you might need. In the second situation, you have freedom to set up your own database, in which case you’ll have to own it – and that comes with its own set of headaches.</p>
<p>There’s a third family of options for data storage that is quickly rising in popularity for medium-sized data. These options allow you to store data in a flat file, but access it in a smarter way than “just load all the data into memory”. SQLite is a classic example on this front that gives you SQL access to what is basically just a flat file. There are also newer entrants into this place that are better from an analytics perspective, like combining Apache Arrow with feather and parquet files and the dask project in Python.</p>
<p>These tools can give you the best of both worlds: you get away from the R and Python limitation of having to load all your data into memory, without having to run a separate database server. But you’ll still have to keep track of where the actual files are and make them accessible to your app.</p>
<p>One last option is a shared spreadsheet like Google Drive. This can be a good solution because you don’t have to host it anywhere yourself, access is easy to control, and there are simple tools for interacting.</p>
</section>
<section id="storage-location" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="storage-location"><span class="header-section-number">3.3.2</span> Storage Location</h3>
<p>The second question after what you’re storing is where. If you are using a database, then the answer is easy. The database just lives where it lives, and you’ll need to make sure you have a way to access it – both in terms of network access, as well as making sure you can authenticate into it (more on that below).</p>
<p>If you’re not using a database, then you’ll have to decide where to store the data for your app. Most apps that aren’t using a database start off rather naively with the data in the app bundle.</p>
<p>&lt;TODO: Image of data in app bundle&gt;</p>
<p>This works really well during development and is an easy pattern to get started with. Usually this pattern works fine for a while. The problem is that this pattern generally falls apart when it goes to production. Problems start to arise when the data needs updating – and most data needs updating. Usually, you’ll be ready to update the data in the app long before you’re ready to update the app itself.</p>
<p>At this point, you’ll be kicking yourself that you now have to update the data inside the app every time you want to make a data update. It’s generally a better idea to have the data live outside the app bundle. Then you can update the data without mucking around with the app itself.</p>
<p>A few options for this include just putting a flat file (or flat with differential read) into a directory near the app bundle. The <code>pins</code> package is also a great option here.</p>
</section>
</section>
<section id="choosing-your-storage-solution" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="choosing-your-storage-solution"><span class="header-section-number">3.4</span> Choosing your storage solution</h2>
<section id="how-frequently-are-the-data-updated-relative-to-the-code" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="how-frequently-are-the-data-updated-relative-to-the-code"><span class="header-section-number">3.4.1</span> How frequently are the data updated relative to the code?</h3>
<p>Many data apps have different update requirements for different data in the app.</p>
<p>For example, imagine you were the data scientist for a wildlife group that needed a dashboard to track the types of animals that had been spotted by a wilderness wildlife camera. You probably have a table that gives parameters for the animals themselves – perhaps things like endangered status, expected frequency, and more. That table probably needs to be updated very infrequently.</p>
<p>On the other hand, the day to day counts of the number of animals spotted probably needs to be updated much more frequently.</p>
<p>If your data is updated only very infrequently, it might make sense to just bundle it up with the app code and update it on a similar cadence to the app itself.</p>
<p>&lt;TODO: Picture data in app bundle&gt;</p>
<p>On the other hand, the more frequently updated data probably doesn’t make sense to update at the same cadence as the app code. You probably want to access that data in some sort of external location, perhaps on a mounted drive outside the app bundle, in a pin or bucket, or in a database.</p>
<p>In my experience, you almost never want to actually bundle data into the app. You almost always want to allow for the app data (“state”) to live outside the app and for the app to read it at runtime. Even data that you think will be updated infrequently, is unlikely to be updated as infrequently as your app code. Animals move on and off the endangered list, ingredient substitutions are made, and hospitals open and close and change their names in memoriam of someone.</p>
<p>It’s also worth considering whether your app needs a live data connection to do processing, or whether looking up values in a pre-processed table will suffice. The more complex the logic inside your app, the less likely you’ll be able to anticipate what users need, and the more likely you’ll have to do a live lookup.</p>
</section>
<section id="is-your-app-read-only-or-does-it-have-to-write" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="is-your-app-read-only-or-does-it-have-to-write"><span class="header-section-number">3.4.2</span> Is your app read-only, or does it have to write?</h3>
<p>Many data apps are read-only. This is nice. If you’re going to allow your app to write, you’ll need to be careful about permissions, protecting from data loss via SQL injection or other things, and you have to be careful to check data quality.</p>
<p>If you want to save the data, you’ll also need a solution for that. There’s no one-size-fits-all answer here as it really depends on the sort of data you’re using. The main thing to keep in mind is that if you’re using a database, you’ll have to make sure you have write permissions.</p>
</section>
</section>
<section id="when-does-the-app-fetch-its-data" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="when-does-the-app-fetch-its-data"><span class="header-section-number">3.5</span> When does the app fetch its data?</h2>
<p>Does the app fetch its data at app open or throughout runtime?</p>
<p>The first important question you’ll have to figure out is what the requirements are for the code you’re trying to put into production.</p>
<section id="how-big-are-the-data-in-the-app" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="how-big-are-the-data-in-the-app"><span class="header-section-number">3.5.1</span> How big are the data in the app?</h3>
<p>When I ask this question, people often jump to the size of the raw data they’re using – but that’s often a completely irrelevant metric. You’re starting backwards if you start from the size of the raw data. Instead, you should figure out what’s the size of data you actually need inside the app.</p>
<p>To make this a little more concrete, let’s imagine you work for a large retailer and are responsible for creating a dashboard that will allow people to visualize the last week’s worth of sales for a variety of products. With this vague prompt, you could end up needing to load a huge amount of data into your app – or very little at all.</p>
<p>One of the most important questions is how much you can cache before someone even opens the app. For example, if you need to provide total weekly sales at the department level, that’s probably just a few data points. And even if you need to go back a long ways, it’s just a few hundred data points.</p>
<p>But if you start needing to slice and dice the data in a lot of directions, then the data size starts multiplying, and you may have to include the entire raw data set in the report. For example, if you need to include weekly sales at the department level, then the size of your data is the <span class="math inline">\(number of weeks * number of departments\)</span>. If you need to include more dimensions – say you need to add geographies, then your data size <strong>multiplies</strong> by the number of geographies.</p>
</section>
<section id="what-are-the-performance-requirements-for-the-app" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="what-are-the-performance-requirements-for-the-app"><span class="header-section-number">3.5.2</span> What are the performance requirements for the app?</h3>
<p>One crucial question for your app is how much wait time is acceptable for people wanting to see the app – and when is that waiting ok? For example, if people need to be able to make selections and see the results in realtime, then you probably need a snappy database, or all the data preloaded into memory when they show up.</p>
<p>For some apps, you want the data to be snappy throughout runtime, but it’s ok to have a lengthy startup process (perhaps because it can happen before the user actually arrives) and you want to load a lot of data as the app is starting and do much less throughout the app runtime.</p>
</section>
<section id="creating-performant-database-queries" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="creating-performant-database-queries"><span class="header-section-number">3.5.3</span> Creating Performant Database Queries</h3>
<p>If you are using a database, you’ll want to be careful about how you construct your queries to make sure they perform well. The main way to think about this is whether your queries will be eager or lazy.</p>
<p>In an eager app, you’ll pull basically all of the data for the app as it starts up, while a lazy app will pull data only as it is need.</p>
<p>&lt;TODO: Diagram of eager vs lazy data pulling&gt;</p>
<p>Making your app eager is usually much simpler – you just read in all the data at the beginning. This is often a good first cut at writing an app, as you’re not sure exactly what requirements your app has. For relatively small datasets, this is often good enough.</p>
<p>If it seems like your app is starting up slowly – or your data’s too big to all pull in, you may want to pull data more lazily.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Before you start converting queries to speed up your app, it’s always worthwhile to profile your app and actually check that the data pulling is the slow step. I’ve often been wrong in my intuitions about what the slow step of the app is.</p>
<p>There’s nothing more annoying than spending hours refactoring your app to pull data more lazily only to realize that pulling the data was never the slow step to begin with.</p>
</div>
</div>
<p>It’s also worth considering how to make your queries perform better, regardless of when they occur in your code. You want to pull the minimum amount of data possible, so making data less granular, pulling in a smaller window of data, or pre-computing summaries is great when possible (though again, it’s worth profiling before you take on a lot of work that might result in minimal performance improvements).</p>
<p>Once you’ve decided whether to make your app eager or lazy, you can think about whether to make the query eager or lazy. In most cases, when you’re working with a database, the slowest part of the process is actually pulling the data. That means that it’s generally worth it to be lazy with your query. And if you’re using <code>dplyr</code> from R, being eager vs lazy is simply a matter of where in the chain you put the <code>collect</code> statement.</p>
<p>So you’re better off sending a query to the database, letting the database do a bunch of computations, and pulling a small results set back, rather than pulling in a whole data set and doing computations in R.</p>
</section>
<section id="how-to-connect-to-databases" class="level3" data-number="3.5.4">
<h3 data-number="3.5.4" class="anchored" data-anchor-id="how-to-connect-to-databases"><span class="header-section-number">3.5.4</span> How to connect to databases?</h3>
<p>In R, there are two answers to how to connect to a database.</p>
<p>The first option is to use a direct connector to connect to the database. This connector generally will provide a driver to the <code>DBI</code> package. There are other database alternatives, but they’re pretty rare.</p>
<p>&lt;TODO: image of direct connection vs through driver&gt;</p>
<p>Alternatively, you can use an ODBC/JDBC driver to connect to the database. In this case, you’ll use something inside your R or Python session to use a database driver that has nothing to do with R or Python. Many organizations like these because IT/Admins can configure them on behalf of users and can be agnostic about whether users are using them from R, Python, or something else entirely.</p>
<p>If you’re in R, the <code>odbc</code> package gives you a way to interface with ODBC drivers. I’m unaware of a general solution for conencting to odbc drivers in Python.</p>
<p>A DSN is a particular way to configure an ODBC driver. They are nice because it means that the Admin can fill in the connection details ahead of time, and you don’t need to know any details of the connection, other than your username and password.</p>
<p>&lt;TODO: image of how DSN works&gt;</p>
<p>In R, writing a package that creates database connections for users is also a very popular way to provide database connections to the group.</p>
</section>
</section>
<section id="how-do-i-do-data-authorization" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="how-do-i-do-data-authorization"><span class="header-section-number">3.6</span> How do I do data authorization?</h2>
<p>This is a question you probably don’t think about much as you’re puttering around inside RStudio or in a Jupyter Notebook. But when you take an app to production, this becomes a crucial question.</p>
<p>The best and easiest case here is that everyone who views the app has the same permissions to see the data. In that case, you can just allow the app access to the data, and you can check whether someone is authorized to view the app as a whole, rather than at the data access layer.</p>
<p>In some cases, you might need to provide differential data access to different users. Sometimes this can be accomplished in the app itself. For example, if you can identify the user, you can gate access to certain tabs or features of your app. Many popular app hosting options for R and Python data science apps pass the username into the app as an environment variable.</p>
<p>Sometimes you might also have a column in a table that allows you to filter by who’s allowed to view, so you might just be able to filter to allowable rows in your database query.</p>
<p>Sometimes though, you’ll actually have to pass database credentials along to the database, which will do the authorization for you. This is nice, because then all you have to do is pass along the correct credential, but it’s also a pain because you have to somehow get the credential and send it along with the query.</p>
<p>&lt;TODO: Image of how a kinit/JWT flow work&gt;</p>
<p>Most commonly, Kerberos tickets or JSON web tokens (JWTs) are used for this task. Usually your options for this depend on the database itself, and the ticket/JWT granting process will likely have to be handled by the database admin.</p>
<section id="securely-managing-credentials" class="level3" data-number="3.6.1">
<h3 data-number="3.6.1" class="anchored" data-anchor-id="securely-managing-credentials"><span class="header-section-number">3.6.1</span> Securely Managing Credentials</h3>
<p>The single most important thing you can do to secure your credentials for your outside services is to avoid ever putting credentials in plaintext. The simplest alternative is to do a lookup from environment variables in either R or Python. There are many more secure things you can do, but it’s pretty trivial to put <code>Sys.getenv("my_db_password")</code> into an app rather than actually typing the value. In that case, you’d set the variable in an <code>.Rprofile</code> or <code>.Renviron</code> file.</p>
<p>Similarly, in Python, you can get and set environment variables using the <code>os</code> module. <code>os.environ['DB_PASSWORD'] = 'my-pass'</code> and <code>os.getenv('DB_PASSWORD')</code>, <code>os.environ.get('DB_PASSWORD')</code> or <code>os.environ('DB_PASSWORD')</code>. If you want to set environment variables from a file, generally people in Python use the<code>dotenv</code> package along with a <code>.env</code> file.</p>
<p>You should not commit these files to git, but should manually move them across environments, so they never appear anywhere centrally accessible.</p>
<p>In some organizations, this will still not be perceived as secure enough, because the credentials are not encrypted at rest. Any of the aforementioned files are just plain text files – so if someone unauthorized were to get access to your machine, they’d be able to grab all of the goodies in your <code>.Rprofile</code> and use them themselves.</p>
<p>Some hosting software, like RStudio Connect, can take care of this problem, as they store your environment variables inside the software in an encrypted fashion and inject them into the R runtime.</p>
<p>There are a number of more secure alternatives – but they generally require a little more work.</p>
<p>There are packages in both R and Python called <code>keyring</code> that allow you to use the system keyring to securely store environment variables and recall them at runtime. These can be good in a development environment, but run into trouble in a production environment because they generally rely on a user actually inputting a password for the system keyring.</p>
<p>One popular alternative is to use credentials pre-loaded on the system to enable using a ticket or token – often a Kerberos token or a JWT. This is generally quite do-able, but often requires some system-level configuration.</p>
<p>&lt;TODO: image of kerberos&gt;</p>
<p>You may need to enable running as particular Linux users if you don’t want to do all of the authentication interactively in the browser. You usually cannot just recycle login tokens, because they are service authorization tokens, not token-granting tokens.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</section>
</section>
<section id="comprehension-questions" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="comprehension-questions"><span class="header-section-number">3.7</span> Comprehension Questions</h2>
<ol type="1">
<li>What are the layers of a three-layer application architecture? What libraries could you use to implement a three-layer architecture in R or Python?</li>
<li>What is the relationship between an R or Python function and an API?</li>
<li>What are the different options for data storage formats for apps? What are the advantages and disadvantages of each? How does update frequency relate to choosing a data storage format?</li>
<li>When should an app fetch all of the data up front? When is it better for the app to do live data fetches?</li>
<li>What is a good way to create a non-performant database query?</li>
</ol>
</section>
<section id="portfolio-exercise-standing-up-a-loosely-coupled-app" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="portfolio-exercise-standing-up-a-loosely-coupled-app"><span class="header-section-number">3.8</span> Portfolio Exercise: Standing Up a Loosely Coupled App</h2>
<p>Find a public data source you like that’s updated on a regular candence. Some popular ones include weather, public transit, and air travel.</p>
<p>Create a job that uses R or Python to access the data and create a job to put it into a database (make sure this is compliant with the data use agreement).</p>
<p>Create an API in Plumber (R) or Flask or FastAPI (Python) that allows you to query the data – or maybe create a machine learning model that you can run against new data coming in.</p>
<p>Create an app that visualizes what’s coming out of the API using Dash or Streamlit (Python) or Shiny (either R or Python).</p>


</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>I believe that it is theoretically possible to create a token that grants access to multiple services. For example, you could have a token that grants access to both RStudio Server and a database. I’ve never seen this implemented.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../chapters/sec1/1-2-env-as-code.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Environments as Code</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../chapters/sec1/1-4-monitor-log.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Logging and Monitoring</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, Alex K Gold</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link active" href="https://github.com/akgold/do4ds" aria-current="page">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/alexkgold">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>