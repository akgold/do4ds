<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DevOps for Data Science - 5&nbsp; Logging and Monitoring</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../chapters/sec2/2-0-sec-intro.html" rel="next">
<link href="../../chapters/sec1/1-4-apis.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BTSMMRMH08"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BTSMMRMH08', { 'anonymize_ip': true});
</script>


</head>

<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Logging and Monitoring</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">DevOps for Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/akgold/do4ds" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">Welcome!</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/intro.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec1/1-0-sec-intro.html" class="sidebar-item-text sidebar-link">DevOps Lessons for Data Science</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-1-code-promotion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Code promotion and integration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-2-env-as-code.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Environments as Code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-3-data-arch.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data Pipeline Architecture</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-4-apis.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Designing Your Application Layers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-5-monitor-log.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Logging and Monitoring</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec2/2-0-sec-intro.html" class="sidebar-item-text sidebar-link">IT/Admin Tools</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-1-terminal.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Terminal</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-2-ssh.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Connecting Securely with SSH</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-3-cmd-line.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Getting comfortable on the Command Line</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-4-docker.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Docker for Data Science</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec3/3-0-sec-intro.html" class="sidebar-item-text sidebar-link">IT/Admin for Data Science</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-1-cloud.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Getting Started with the Cloud</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-2-linux-admin.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Basic Linux SysAdmin</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-3-networking.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Intro to Computer Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-4-dns.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">DNS allows for human-readable addresses</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-5-ssl.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">You should use SSL/HTTPS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-6-servers.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Choosing the right server for you</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec4/4-0-sec-intro.html" class="sidebar-item-text sidebar-link">Making it Enterprise-Grade</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-1-os-ds-in-ent.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Open Source Data Science in the Enterprise</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-2-ent-networks.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Enterprise Networking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-3-auth.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Logging in with auth</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-4-scaling.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Scaling</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/append/docker-cheatsheet.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Docker Cheatsheet</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#working-with-logs-and-metrics" id="toc-working-with-logs-and-metrics" class="nav-link active" data-scroll-target="#working-with-logs-and-metrics"><span class="toc-section-number">5.1</span>  Working with logs and metrics</a>
  <ul class="collapse">
  <li><a href="#how-to-write-logs" id="toc-how-to-write-logs" class="nav-link" data-scroll-target="#how-to-write-logs"><span class="toc-section-number">5.1.1</span>  How to write logs</a></li>
  <li><a href="#how-to-emit-metrics" id="toc-how-to-emit-metrics" class="nav-link" data-scroll-target="#how-to-emit-metrics"><span class="toc-section-number">5.1.2</span>  How to emit metrics</a></li>
  <li><a href="#consuming-logs-and-metrics" id="toc-consuming-logs-and-metrics" class="nav-link" data-scroll-target="#consuming-logs-and-metrics"><span class="toc-section-number">5.1.3</span>  Consuming Logs and Metrics</a></li>
  </ul></li>
  <li><a href="#comprehension-questions" id="toc-comprehension-questions" class="nav-link" data-scroll-target="#comprehension-questions"><span class="toc-section-number">5.2</span>  Comprehension Questions</a></li>
  <li><a href="#portfolio-exercise-adding-logging" id="toc-portfolio-exercise-adding-logging" class="nav-link" data-scroll-target="#portfolio-exercise-adding-logging"><span class="toc-section-number">5.3</span>  Portfolio Exercise: Adding Logging</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/akgold/do4ds/edit/main/chapters/sec1/1-5-monitor-log.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-log-monitor" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Logging and Monitoring</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Jobs fail. Apps mysteriously quit. These things happen.</p>
<p>When they do, I’d much rather find out from an automated email or slack message than an angry message from the CTO.</p>
<p>The state of knowing how things are going with your system and being able to reconstruct what happened when something (inevitably) does go awry is generally called <em>observability</em> in DevOps lingo.</p>
<p>When software engineers think about observability, they’re generally thinking about observing the <em>operational</em> qualities of their app. When they think about errors or performance, they’re thinking in terms of actual code error states that crash the app and performance is basically synonymous with the app being fast enough for users. As a data scientist, you should care about these things.</p>
<p>Understanding <em>access patterns</em> for your app is important. It’s useful to know if your app is getting usage and if so whether people are using certain parts. You want to make sure they’re having a good experience when they do so.</p>
<p>Knowing that people are using your project is important to understand if there are extensions to your project that might be useful and also to make the case inside your organization that you are doing valuable work. It’s also useful in the case that your organization requires an <em>audit trail</em> or who read or wrote particular data.</p>
<p>Unlike when you’re running code right in your terminal, you’re not going to be paying close attention to code running in production. If (when, really) there’s an error, you may not get to it right away, and you’ll want the necessary information to re-create the state of the system just before the error occurred. Knowing that an error has occurred and what the system looked like when an error occurred is extremely useful to figure out why it happened.</p>
<p>In addition to these operational concerns you share with software engineers, there’s an additional level of complexity to observability related to the actual data science profile of your app. An error doesn’t always mean that your app crashes – it could just return an incorrect result, which is often scarier. For example, your ETL pipeline could complete on time, but data quality could’ve deteriorated so much that the output data is basically meaningless. Or your machine learning model could have fallen out of alignment, so it’s still returning predictions – just wrong ones.</p>
<p>There are two general practices that enable observability of software – <em>logging</em> and <em>monitoring.</em></p>
<p>Logging is the process of documenting and saving a record of what happened when a piece of software ran in the form of a <em>log</em>. Logs are useful for documenting what’s happening inside a software system under both normal operations and reconstructing the sequence of events prior to a failure.</p>
<p>Monitoring is the process of generating and tracking <em>metrics</em> of how the system is doing. Metrics are quantitative measurements of the system, which include things like CPU, RAM, and disk usage as well as numbers of users and response times. Monitoring involves making sure those metrics are within normal operating parameters, and alerting the right people when – or ideally before – something goes wrong.</p>
<p>For both monitoring and logging, there are two separate things to think about: how does your system <em>emit</em> logs and metrics and how do you consume those logs and metrics to make them useful?</p>
<p>The good news it that as a data scientist, you’re probably very familiar with one form of logging.</p>
<p>A lot of data science work is done in a literate programming format – Jupyter Notebooks, R Markdown Documents, and Quarto Documents. If used right, the beauty of these documents is that they are self-logging in most cases!</p>
<p>In one of my spicier opinions, data scientists should do <em>all</em> jobs in a literate programming format. If you write your code in a literate programming format and include metrics in the document, you’ve got a self-logging job.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Literate ETL Jobs
</div>
</div>
<div class="callout-body-container callout-body">
<p>For ETL jobs in particular, there are two things I find are always essential to log.</p>
<p>The first is the quality of data joins. If you suddenly have a lot of non-matches – or duplicate matches, things can get very, very weird.</p>
<p>The second is cross-tabulations before and after recoding the values of a variable. Making sure your recode logic does what you think and that the values coming in aren’t changing over time has saved my butt many times.</p>
</div>
</div>
<p>But we don’t get to ignore the software engineering concerns of a good service experience for our users. This makes observability <em>even more</em> important in a data science context than in a pure software engineering one. You’ll still need to think about monitoring metrics and how to log in the event of an actual code failure, but you’ve at least documented the data science qualities of your work.</p>
<section id="working-with-logs-and-metrics" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="working-with-logs-and-metrics"><span class="header-section-number">5.1</span> Working with logs and metrics</h2>
<p>I’m assuming you already have a good sense of how to include helpful tabulations in your literate programming formats, so the rest of this chapter is going to be able logging and monitoring as distinct from just including the right output in your Jupyter Notebook, Quarto document, or R Markdown document.</p>
<p>Monitoring and logging are somewhat nascent practices for data scientists. Part of the purpose of this chapter is to convince you they shouldn’t be! And to show you that they’re really not that hard.</p>
<p>Emitting logs can be as simple as just putting <code>print</code> statements throughout your code – but there are much better ways.</p>
<p>And you’re a data scientist – if you’re putting information into your logs, it’s probably not hard to scrape that data into structured metrics data should the need ever arise. That said, the barrier to entry for actually emitting metrics is way lower than you might realize, and most data scientists should probably pay more attention to emitting metrics than they do.</p>
<p>Whether you need to emit metrics is a more subtle question. It really depends on the criticality of your system. In many data science contexts, you aren’t going to do monitoring on a real-time basis, so emitting metrics that can be used by a real-time monitoring system is less important than for other types of software.</p>
<section id="how-to-write-logs" class="level3" data-number="5.1.1">
<h3 data-number="5.1.1" class="anchored" data-anchor-id="how-to-write-logs"><span class="header-section-number">5.1.1</span> How to write logs</h3>
<p>Python has a standard logging package that is excellent and you should use that. R does not have a standard logging package, but there are a number of excellent CRAN packages for logging. My personal favorite is <a href="https://cran.r-project.org/web/packages/log4r/index.html"><code>log4r</code></a>.</p>
<p>Every time you log something, that is a <em>log entry</em>. Every log entry has <em>log data</em> – that would be a description of what’s being logged, perhaps something like “Button A Pressed”. Every entry also has a <em>log level</em>. The log level describes how scary the thing you’re logging is.</p>
<p>Most logging libraries have 5-7 levels of logging. Both the Python <code>logging</code> library and <code>log4r</code> use these five levels from most to least scary:</p>
<ol type="1">
<li><em>Critical</em>: an error so big that the app itself shuts down. For example, if your app cannot run without a connection to an outside service, you might log an inability to connect as a Critical error.</li>
<li><em>Error</em>: an issue that will make an operation not work, but that won’t bring down your app. In the language of software engineering, you might think of this as a caught exception. An example might be a user submitting invalid input.</li>
<li><em>Warn/Warning</em>: an unexpected application issue that isn’t fatal. For example, you might include having to retry doing something or noticing that resource usage is high. If something were to go wrong later, these might be helpful breadcrumbs to look at.</li>
<li><em>Info</em>: something normal happened in the app. These record things like starting and stopping, successfully making database and other connections, and configuration options that are used.</li>
<li><em>Debug</em>: a deep record of what the app was doing. The debug log is meant for people who understand the app code to be able to understand what functions ran and with what arguments.</li>
</ol>
<p>The nice thing about using a logger as opposed to just print statements is that they make it easy to consistently use these log levels. They also can automatically append other helpful information to each log record – like the timestamp or the active user.</p>
<p>As the log record is written, it has to be formatted using a <em>formatter</em> or <em>layout</em>. In most cases, the default log format is in plain text.</p>
<p>So if you log “Button pressed” at the info level, your log record might look something like this in the file:</p>
<pre><code>2022-11-18 21:57:50 INFO Button Pressed</code></pre>
<p>But if you’re shipping your logs off to have them consumed by some other service, you might prefer to have a highly structured log file. The most common structured logging format is JSON, though it’s also possible to use something like YAML or XML. If you used JSON logging, the same record might be emitted as:</p>
<pre><code>{
  "time": "2022-11-18 21:57:50",
  "level": "INFO", 
  "data": "Button Pressed"
}</code></pre>
<p>Once your log record is created, it needs to be put somewhere for you to get it later via a <em>handler</em> in <code>logger</code> or an <em>appender</em> in <code>log4r</code>.</p>
<p>The first (and most common) way to handle logs is just to append them to a file on disk. Many logging consumers are very comfortable watching a file somewhere and aggregating lines of the log as they are written to the file. If you’re not already familiar with how to consume log files, you’ll learn a lot more about this in <a href="../sec2/2-3-cmd-line.html">Chapter&nbsp;<span>8</span></a> on using the command line.</p>
<p>If you are emitting logs to file, you may also want to consider how long those logs stay around. <em>Log rotation</em> is the process of storing logs for a period of time and then deleting the old ones. A common log rotation pattern is to have a 24-hour log file. Each day, the system automatically sets up a new log file and deletes the oldest one (30 days is a typical retention period). The Python <code>logging</code> library does log rotation itself. <code>log4r</code> does not, but there is a Linux library called <code>logrotate</code> that you can use in concert with <code>log4r</code>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>In some cases, you may not want to write to a file on disk. This is most common because you’re running in a Docker container – perhaps in a Kubernetes cluster. As you’ll learn more about in <a href="../sec2/2-4-docker.html">Chapter&nbsp;<span>9</span></a>, anything that lives inside a Docker container is ephemeral. This is obviously bad if you’re writing a log that might contain clues for why a Docker container was unexpectedly killed.</p>
<p>In that case, you may want to direct log entries somewhere alternative or additional to a log file. Linux provides one facility specifically for receiving normal output called <em>stdout</em> (usually pronounced standard out) and one for errors called <em>stderr</em> (standard error).</p>
<p>In a Docker/Kubernetes context, you’ll usually emit your logs inside the running container to stdout/stderr and then have some sort of more permanent service collecting the logs outside.</p>
<p>Lastly, it’s possible you want to do something else completely custom with your logs. This is most common for critical or error logs. For example, you may want to send an email, slack, or text message immediately if your system emits a high-level log message.</p>
<p>Both <code>logger</code> and <code>log4r</code> have various ways of sending arbitrary messages to other services.</p>
<p>The last piece to logging is configuring your logging environment. When you initialize your logger, you’ll set the default level at which to log events. In <code>log4r</code>, the default level is INFO. For <code>logger</code>, it’s WARNING. This means that, by default, any log less critical than those levels won’t be logged.</p>
<p>This is a great use case for environment variables, as explained in <a href="1-1-code-promotion.html#sec-env-vars">Section&nbsp;<span>1.4</span></a>. It’s likely that you’ll want to configure different levels of logging in production vs development apps.</p>
</section>
<section id="how-to-emit-metrics" class="level3" data-number="5.1.2">
<h3 data-number="5.1.2" class="anchored" data-anchor-id="how-to-emit-metrics"><span class="header-section-number">5.1.2</span> How to emit metrics</h3>
<p>Monitoring is a much more nascent practice in Data Science than logging. The main place metrics have a footprint is in the MLOps/ModelOps domain. For many data science use cases, emitting metrics may not be necessary.</p>
<p>These days, most people use the Prometheus/Grafana stack for open source monitoring of servers and their resources.</p>
<p><a href="https://prometheus.io/">Prometheus</a> is an open source monitoring tool that makes it easy to store metrics data, query that data, and alert based on it. <a href="https://grafana.com/">Grafana</a> is an open source dashboarding tool that sits on top of Prometheus to do visualization of the metrics. They are usually used together to do monitoring and visualization of metrics.</p>
<p>It’s very easy to monitor the server your data science asset might sit on. Prometheus includes something called a <em>node exporter</em>, which makes it extremely easy to monitor the system resources of your server.</p>
<p>Python has an official Prometheus client you can use for emitting metrics from a Python asset, and the <a href="https://github.com/atheriel/openmetrics">openmetrics</a> package in R makes it easy to emit metrics from a Plumber API or Shiny app.</p>
<p>This means that you can instrument your Python or R asset to emits metrics in a format that Prometheus recognizes, Prometheus watches the metrics and stores them and alerts if necessary, and you have a Grafana dashboard available for visualizing those metrics as needed.</p>
<p>For ModelOps in particular, there are also many specialized platforms for monitoring the performance of models over time. The open source <code>vetiver</code> package in R and Python is a model deployment framework that offers built-in facilities for extracting model metrics and putting them in a dashboard (there is currently no prometheus integration).</p>
</section>
<section id="consuming-logs-and-metrics" class="level3" data-number="5.1.3">
<h3 data-number="5.1.3" class="anchored" data-anchor-id="consuming-logs-and-metrics"><span class="header-section-number">5.1.3</span> Consuming Logs and Metrics</h3>
<p>Once you’ve got your asset instrumented and your logging going, you’ll want to use them. If you’re using a professional product like Posit Connect to host your asset, you will probably get some degree of support for finding and reading relevant logs out of the box.</p>
<p>If not, you’ll probably be making good use of the skills we’ll review in <a href="../sec3/3-2-linux-admin.html">Chapter&nbsp;<span>11</span></a> to watch logs and parse them.</p>
<p>You also can configure the Prometheus and Grafana stack to do both metrics monitoring and log aggregation. Grafana provides a generous free tier that allows you to use Prometheus and Grafana to do your monitoring without having to set up your own server. You can just set up their service and point your app to it.</p>
<p>There’s a great <a href="https://grafana.com/docs/grafana/latest/getting-started/get-started-grafana-prometheus/">Get Started with Grafana and Prometheus</a> doc on the GrafanaLabs website if you want to actually try it out.</p>
</section>
</section>
<section id="comprehension-questions" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="comprehension-questions"><span class="header-section-number">5.2</span> Comprehension Questions</h2>
<ol type="1">
<li>What is the difference between monitoring and logging? What are the two halves of the monitoring and logging process?</li>
<li>In general, logging is good, but what are some things you should be careful <em>not to log</em>?</li>
<li>At what level would you log each of the following events:
<ol type="1">
<li><p>Someone clicks on a particular tab in your Shiny app.</p></li>
<li><p>Someone puts an invalid entry into a text entry box.</p></li>
<li><p>An <code>http</code> call your app makes to an external API fails.</p></li>
<li><p>The numeric values that are going into your computational function.</p></li>
</ol></li>
</ol>
</section>
<section id="portfolio-exercise-adding-logging" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="portfolio-exercise-adding-logging"><span class="header-section-number">5.3</span> Portfolio Exercise: Adding Logging</h2>
<p>Using the appropriate package for whichever language you wrote in, add robust logging to both the API and the App you built.</p>
<p>For an extra challenge, consider trying to emit Prometheus metrics as well and consume them using Prometheus and Grafana.</p>


</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>There are two common naming patterns with rotating log files. The first is to have dated log filenames that look like <code>my-log-20221118.log</code>.</p>
<p>The other pattern is to keep one file that’s current and have the older ones numbered. So today’s log would be <code>my-log.log</code>, yesterday’s would be <code>my-log.log.1</code> , the day before <code>my-log.log.2</code>, etc. This second pattern works particularly well if you’re using <code>logrotate</code> with <code>log4r</code>, because then <code>log4r</code> doesn’t need to know anything about the log rotation. It’s just always writing to <code>my-log.log</code>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../chapters/sec1/1-4-apis.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Designing Your Application Layers</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../chapters/sec2/2-0-sec-intro.html" class="pagination-link">
        <span class="nav-page-text">IT/Admin Tools</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, Alex K Gold</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link active" href="https://github.com/akgold/do4ds" aria-current="page">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/alexkgold">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>