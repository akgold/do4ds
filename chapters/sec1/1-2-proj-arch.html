<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DevOps for Data Science - 2&nbsp; Data Project Architecture Guidelines</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../chapters/sec1/1-3-data-access.html" rel="next">
<link href="../../chapters/sec1/1-1-env-as-code.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EQR1RYSHQK"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-EQR1RYSHQK', { 'anonymize_ip': true});
</script>
<script src="../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../chapters/sec1/1-0-sec-intro.html">DevOps Lessons for Data Science</a></li><li class="breadcrumb-item"><a href="../../chapters/sec1/1-2-proj-arch.html"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Project Architecture Guidelines</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">DevOps for Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/akgold/do4ds" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec1/1-0-sec-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DevOps Lessons for Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-1-env-as-code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Environments as Code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-2-proj-arch.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Project Architecture Guidelines</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-3-data-access.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Using databases and data APIs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-4-monitor-log.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Logging and Monitoring</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec1/1-5-deployments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Deployments and code promotion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec2/2-0-sec-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IT/Admin Tools</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-1-terminal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">The Terminal</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-2-ssh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Connecting Securely with SSH</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-3-cmd-line.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Getting comfortable on the Command Line</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec2/2-4-docker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Demystifying Docker</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec3/3-0-sec-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IT/Admin for Data Science</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-1-cloud.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Getting Started with the Cloud</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-2-linux-admin.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Basic Linux SysAdmin</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-3-networking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Intro to Computer Networks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-4-dns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">DNS allows for human-readable addresses</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-5-ssl.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">You should use SSL/HTTPS</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec3/3-6-servers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Choosing the right server for you</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../chapters/sec4/4-0-sec-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Making it Enterprise-Grade</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-1-os-ds-in-ent.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Open Source Data Science in the Enterprise</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-2-ent-networks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Enterprise Networking</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-3-auth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Auth in Enterprise</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/sec4/4-4-ent-servers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Enterprise Server Management</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/append/auth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Auth Technologies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../chapters/append/lab-map.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Lab Map</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#choose-the-right-type-of-presentation-layer" id="toc-choose-the-right-type-of-presentation-layer" class="nav-link active" data-scroll-target="#choose-the-right-type-of-presentation-layer"><span class="header-section-number">2.1</span> Choose the right type of presentation layer</a></li>
  <li><a href="#do-less-in-the-presentation-layer" id="toc-do-less-in-the-presentation-layer" class="nav-link" data-scroll-target="#do-less-in-the-presentation-layer"><span class="header-section-number">2.2</span> Do less in the presentation layer</a></li>
  <li><a href="#aim-for-small-data-in-the-presentation-layer" id="toc-aim-for-small-data-in-the-presentation-layer" class="nav-link" data-scroll-target="#aim-for-small-data-in-the-presentation-layer"><span class="header-section-number">2.3</span> Aim for small data in the presentation layer</a>
  <ul class="collapse">
  <li><a href="#can-i-add-pre-calculation-or-use-a-different-project-type" id="toc-can-i-add-pre-calculation-or-use-a-different-project-type" class="nav-link" data-scroll-target="#can-i-add-pre-calculation-or-use-a-different-project-type"><span class="header-section-number">2.3.1</span> Can I add pre-calculation or use a different project type?</a></li>
  <li><a href="#can-i-reduce-data-granularity" id="toc-can-i-reduce-data-granularity" class="nav-link" data-scroll-target="#can-i-reduce-data-granularity"><span class="header-section-number">2.3.2</span> Can I reduce data granularity?</a></li>
  </ul></li>
  <li><a href="#big-data-patterns" id="toc-big-data-patterns" class="nav-link" data-scroll-target="#big-data-patterns"><span class="header-section-number">2.4</span> Adopt a pattern to make big data small</a>
  <ul class="collapse">
  <li><a href="#be-lazy-with-data-pulls" id="toc-be-lazy-with-data-pulls" class="nav-link" data-scroll-target="#be-lazy-with-data-pulls"><span class="header-section-number">2.4.1</span> Be lazy with data pulls</a></li>
  <li><a href="#sample-the-data" id="toc-sample-the-data" class="nav-link" data-scroll-target="#sample-the-data"><span class="header-section-number">2.4.2</span> Sample the data</a></li>
  <li><a href="#chunk-and-pull" id="toc-chunk-and-pull" class="nav-link" data-scroll-target="#chunk-and-pull"><span class="header-section-number">2.4.3</span> Chunk and pull</a></li>
  <li><a href="#push-work-to-the-data-source" id="toc-push-work-to-the-data-source" class="nav-link" data-scroll-target="#push-work-to-the-data-source"><span class="header-section-number">2.4.4</span> Push work to the data source</a></li>
  </ul></li>
  <li><a href="#store-intermediate-artifacts-in-the-right-format" id="toc-store-intermediate-artifacts-in-the-right-format" class="nav-link" data-scroll-target="#store-intermediate-artifacts-in-the-right-format"><span class="header-section-number">2.5</span> Store intermediate artifacts in the right format</a></li>
  <li><a href="#choose-where-based-on-update-frequency" id="toc-choose-where-based-on-update-frequency" class="nav-link" data-scroll-target="#choose-where-based-on-update-frequency"><span class="header-section-number">2.6</span> Choose where based on update frequency</a></li>
  <li><a href="#consider-auth-to-data-up-front" id="toc-consider-auth-to-data-up-front" class="nav-link" data-scroll-target="#consider-auth-to-data-up-front"><span class="header-section-number">2.7</span> Consider auth to data up front</a></li>
  <li><a href="#create-an-api-if-you-need-it" id="toc-create-an-api-if-you-need-it" class="nav-link" data-scroll-target="#create-an-api-if-you-need-it"><span class="header-section-number">2.8</span> Create an API if you need it</a></li>
  <li><a href="#write-a-data-flow-chart" id="toc-write-a-data-flow-chart" class="nav-link" data-scroll-target="#write-a-data-flow-chart"><span class="header-section-number">2.9</span> Write a data flow chart</a></li>
  <li><a href="#comprehension-questions" id="toc-comprehension-questions" class="nav-link" data-scroll-target="#comprehension-questions"><span class="header-section-number">2.10</span> Comprehension Questions</a></li>
  <li><a href="#lab2" id="toc-lab2" class="nav-link" data-scroll-target="#lab2"><span class="header-section-number">2.11</span> Lab 2: Build the processing layer</a>
  <ul class="collapse">
  <li><a href="#step-1-write-the-model-outside-the-bundle-using-vetiver" id="toc-step-1-write-the-model-outside-the-bundle-using-vetiver" class="nav-link" data-scroll-target="#step-1-write-the-model-outside-the-bundle-using-vetiver"><span class="header-section-number">2.11.1</span> Step 1: Write the model outside the bundle using <code>{vetiver}</code></a></li>
  <li><a href="#step-2-create-an-api-to-serve-model-predictions" id="toc-step-2-create-an-api-to-serve-model-predictions" class="nav-link" data-scroll-target="#step-2-create-an-api-to-serve-model-predictions"><span class="header-section-number">2.11.2</span> Step 2: Create an API to serve model predictions</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/akgold/do4ds/edit/main/chapters/sec1/1-2-proj-arch.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-proj-arch" class="quarto-section-identifier"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data Project Architecture Guidelines</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Like it or not, being a data scientist means you’re also a software developer.</p>
<p>But you’re probably not a very <strong>good</strong> software developer. I know I’m not.</p>
<p>There’s nothing wrong with being a mediocre software developer, except that poorly-architected software is hard to match to good DevOps patterns.</p>
<p>So in this chapter, I’ll share some guidelines about how to design <strong>data flows</strong> for your data science project so it won’t fall apart or have to be rebuilt when you take it to production.</p>
<p>Before we get into designing a data science project, let’s talk about a standard software architecture that’s also helpful for data science projects – the <em>three-layer app</em>.</p>
<p>A three-layer app divides the app’s operations into (you guessed it) three layers, which are:</p>
<ol type="1">
<li><em>Presentation Layer</em> - what the end users of the app directly interact with. It’s the displays, buttons, and functionality the user actually experiences.</li>
<li><em>Processing Layer</em> – all of the processing that actually does something based on user interactions.</li>
<li><em>Data Layer</em> – how and where the app stores and retrieves data.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may also have heard the terms <em>front end</em> and <em>back end</em>. Front end usually refers to the presentation layer and back end to the processing and data layers.</p>
</div>
</div>
<p>Thinking about your project in three layers can clarify the components. But a data science project is different enough from general purpose software that you can’t just take three-layer best practices and directly apply them to a data science project.</p>
<p>First, you ’re designing a project, which is often not just a single app. It’s very likely that you have (or should have) several different components like one or more ETL scripts and a separate script for modeling in addition to a front end app.</p>
<p>Second, most general purpose apps run in response to something users do. In contrast, many data science project run in response to updates to the underlying data – either on a schedule or in response to a trigger.</p>
<p>Third, you may not be designing an app at all. Data science projects produce all kinds of different outputs. An app is one option, but it may not be the best for your project.</p>
<p>Lastly, general purpose software engineers get to design their data layers. You probably don’t. Your job is to extract meaning from a bunch of raw input data, which means you’re beholden to whatever format that data shows up in.</p>
<p>Even with these differences, you do get to make a lot of choices that can make your app easier or harder to take to production. So here’s a set of guidelines I’ve found make it easier to take your project to production when the time is right.</p>
<section id="choose-the-right-type-of-presentation-layer" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="choose-the-right-type-of-presentation-layer"><span class="header-section-number">2.1</span> Choose the right type of presentation layer</h2>
<p>The presentation layer is the actual thing that will be consumed by your users. A lot of the data flows for your project will be dictated by your presentation layer, so you need to start by figuring out the details of your presentation layer.</p>
<p>Basically all data science projects fall into one of four categories.</p>
<p>The first category is a <em>job</em>. A job matters because it changes something in another system. It might move data around, build a model, or produce plots, graphs, or numbers to be used in a Microsoft Office report.</p>
<p>Frequently, jobs are written in a SQL-based pipelining tool (<a href="https://www.getdbt.com/"><em>dbt</em></a> has been quickly rising in popularity) or in a <code>.R</code> or <code>.py</code> script.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>The second type of data science software is an interactive <em>app</em>. These apps are created in frameworks like Shiny (R or Python), Dash (Python), or Streamlit (Python). In contrast to general purpose web apps, which are for all sorts of purposes, data science web apps are usually used to give non-coders a way to explore data sets and see data insights.</p>
<p>The third type is a <em>report</em>. Reports are code you’re turning into an output you care about – like a paper, book, presentation, or website. Reports are the result of rendering an R Markdown doc, Quarto doc, or Jupyter Notebook for people to consume on their computer, in print, or in a presentation. These docs may be completely static (this book is a Quarto doc) or they may have some interactive elements.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Exactly how much interactivity turns a report into an app is completely subjective. I generally think the distinction is whether there’s a running R or Python process in the background, but it’s not a particularly sharp line.</p>
</div>
</div>
<p>The fourth type is an <em>API</em> (application programming interface) for machine-to-machine communication. In the general purpose software world, APIs are the backbone of how two distinct pieces of software communicate. In the data science world, APIs are most often used to provide data feeds and on-demand predictions from machine learning models.</p>
<p>Choosing the right type of presentation layer will make it much easier to design the rest of your project. Here are some guidelines on how to choose a presentation layer.</p>
<p>If the results of your software are for machine-to-machine use, you’re thinking about a job or API. It’s a job if it should run in a batched way (i.e.&nbsp;you write a data file or results into a database) and it’s an an API if you want results as queried in real time.</p>
<p>If your project is for humans to consume, you’re thinking about creating an app or report, depending on whether you need a live Python or R process on the back-end.</p>
<p>Here’s a little flow chart for how I think about which of the four things you should build.</p>
<div class="cell" data-eval="true">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    A{For human\n consumption?}
    B{Static?} 
    C{Lots of data\n on backend?}
    D{Should run\batched?}

    E["Report\n(Static)"]
    F[App] 
    G["Report\n(Interactive)"]
    H[API]
    J[Job]


    A --&gt;|Yes| B
    A --&gt;|No| D
    B --&gt;|Yes| E
    B --&gt;|No| C
    C --&gt;|Yes| F
    C --&gt;|No| G
    D --&gt;|Yes| H
    D --&gt;|No| J
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="do-less-in-the-presentation-layer" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="do-less-in-the-presentation-layer"><span class="header-section-number">2.2</span> Do less in the presentation layer</h2>
<p>As a general rule, data scientists don’t do a great job separating out their presentation layers. It’s not uncommon for me to see apps or reports that are thousands of lines of code, with button definitions, UI bits, and user interaction definitions mixed in among the actual work of the app.</p>
<p>With presentation and processing layers that are smushed together, it’s really hard to read your code later or to test or log what’s happening inside your app.</p>
<p>The best way to separate the presentation layer is to check if you’ve got anything in your presentation layer that does anything beyond</p>
<ul>
<li><p>showing things to the user</p></li>
<li><p>collecting interactions from the user</p></li>
</ul>
<p>Creating the things that are shown to the user or doing anything with the interactions shouldn’t be in the presentation layer. These should be deferred to the processing layer.</p>
<p>Once you’ve identified those things, they should be extracted into functions that are documented and tested – preferably in a package – and use those functions put into standalone scripts.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Moving things out of the presentation layer is especially important if you’re writing a Shiny app. You really want to use the presentation layer to do reactive things and move all non-reactive interactions into the processing layer.</p>
</div>
</div>
</section>
<section id="aim-for-small-data-in-the-presentation-layer" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="aim-for-small-data-in-the-presentation-layer"><span class="header-section-number">2.3</span> Aim for small data in the presentation layer</h2>
<p>Everything is easy when your data is small because you can simply load it into your Python or R session as your code starts and never think about it again.</p>
<p>“Real engineers” may scoff at this pattern, but don’t let their criticism dissuade you. If your data size is small and your project performance is good enough, just read in all of your data and operate on it live. Don’t over-complicate things. These days, this pattern often works well into the range of millions of rows.</p>
<p>It may be the case that your data isn’t small – but not all large data is created equal.</p>
<p>Truly <em>big</em> <em>data</em> can’t fit into the memory on your computer all at once. Data that is actually big is pretty rare for most data science purposes.</p>
<p>It’s much more common to encounter <em>medium data</em>. You can load it into memory so it’s not actually big, but it’s big enough that loading it all makes your project’s performance too slow.</p>
<p>Dealing with medium or big data requires being somewhat clever and adopting <a href="#big-data-patterns">a design pattern for big data</a>. But being clever is hard.</p>
<p>So before you go being clever, it’s worth slowing down and asking yourself a few questions that might let you treat your data as small.</p>
<section id="can-i-add-pre-calculation-or-use-a-different-project-type" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="can-i-add-pre-calculation-or-use-a-different-project-type"><span class="header-section-number">2.3.1</span> Can I add pre-calculation or use a different project type?</h3>
<p>If your data is truly big, it’s big. You could always get beefier hardware, but there are limits. But if your data is medium-sized, the thing keeping it from being small isn’t some esoteric hardware issue, its <strong>performance</strong>.</p>
<p>An app requires high performance. Someone is staring at their screen through a 90 second wait is going to think your project stinks.</p>
<p>But if you can pre-calculate a lookup table of values – or turn your app into a report that gets re-rendered on a schedule you can turn turn medium or even truly big data into a small data set in the presentation layer.</p>
<p>The degree to which you can do this depends a lot on the requirements of your presentation layer.</p>
<p>Talking to your users and figuring out what cuts of the data they really care about can help you determine whether pre-calculation is feasible or whether you really need to load all the data into the presentation layer.</p>
</section>
<section id="can-i-reduce-data-granularity" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="can-i-reduce-data-granularity"><span class="header-section-number">2.3.2</span> Can I reduce data granularity?</h3>
<p>If you can pre-calculate results and you’re still hitting performance issues, it’s always worth asking if your data can get smaller.</p>
<p>Let’s think about a specific project to make this a little clearer.</p>
<p>Suppose you work for a large retailer and are responsible for creating a dashboard of weekly sales. Your input data is a dataset of every item sold at every store going back for years. Clearly this isn’t naturally small data.</p>
<p>As you’re thinking about how to make the presentation layer data smaller, it’s worth keeping in mind that each additional dimension you allow users to cut the data <strong>multiplies</strong> the amount of data you need in the presentation layer.</p>
<p>For example, weekly sales at the department level, requires a lookup table as big as <span class="math inline">\(\text{number of weeks} * \text{number of stores} * \text{number of departments}\)</span>. Even with a lot of stores and a lot of departments, you’re probably still squarely in the small data category.</p>
<p>But if you have to switch to a daily view, you multiply the amount of data you need by 7. If you break it out across 12 products, your data has to get 12 times bigger. And if you do both, it gets 84 times bigger. It’s not long before you’re back to a big data problem.</p>
<p>Talking with your users about the tradeoffs between app performance and the number of data dimensions they need can identify opportunities to exclude dimensions and reduce your data size.</p>
</section>
</section>
<section id="big-data-patterns" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="big-data-patterns"><span class="header-section-number">2.4</span> Adopt a pattern to make big data small</h2>
<p>Let’s say you’ve made your presentation layer as small as possible or you’re trying to do your pre-calculation step to go from big data to small data. You need to figure out how to make your large data smaller.</p>
<p>The key insight is that you don’t want to pull all of the data into your Python or R session. Instead, you want to pull in only some of the data.</p>
<p>Here are a few patterns to consider to make your data smaller. This isn’t an exhaustive list and each of these patterns will only work for some projects, but many can adopt one or more of these patterns.</p>
<section id="be-lazy-with-data-pulls" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1" class="anchored" data-anchor-id="be-lazy-with-data-pulls"><span class="header-section-number">2.4.1</span> Be lazy with data pulls</h3>
<p>Up until now, we’ve been assuming that your project pulls in all of the data up front in an <em>eager</em> data pattern. This is often a good first cut at writing an app, as it’s much simpler than doing anything else.</p>
<p>If that won’t work for your project, you can try being <em>lazy</em> with your data pulls. In a lazy data pattern, you pull in only the data that’s needed when it’s needed.</p>
<p>If your project doesn’t always need all the data – especially if the data it needs depends on what the user does inside a session, it might be worthwhile to pull only exactly the data you need once the user interactions clarify what you need.</p>
</section>
<section id="sample-the-data" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2" class="anchored" data-anchor-id="sample-the-data"><span class="header-section-number">2.4.2</span> Sample the data</h3>
<p>For many tasks, especially machine learning ones, it may be adequate to work on only a sample of the data. In some cases like classification of highly imbalanced classes, it may actually work <em>better</em> to work on a sample of the data rather than the whole data set.</p>
<p>Sampling tends to work well when you’re trying to compute statistical attributes of your datasets. Computing averages or rates and creating machine learning models works just fine on samples of your data. Just be careful to be unbiased with your sampling and consider sampling stratification to make sure one weird sample doesn’t mess with your results.</p>
<p>But sampling doesn’t work well on counting tasks – it’s hard to count when you don’t have all the data!</p>
</section>
<section id="chunk-and-pull" class="level3" data-number="2.4.3">
<h3 data-number="2.4.3" class="anchored" data-anchor-id="chunk-and-pull"><span class="header-section-number">2.4.3</span> Chunk and pull</h3>
<p>In some cases, there may be natural groups in your data. For example, in our retail dashboard example, it may be the case that we want to compute something by time frame or store or product. In this case, you could pull just that chunk of the data, compute what you need and move on to the next one.</p>
<p>Chunking works well for all kinds of tasks including building machine learning models and creating plots as long as the groups are cleanly separable. When they are, this is an example of an <em>embarrassingly parallel</em> task, which you can easily parallelize in Python or R.</p>
<p>If you don’t have distinct chunks in your data, it’s pretty hard to chunk the data.</p>
</section>
<section id="push-work-to-the-data-source" class="level3" data-number="2.4.4">
<h3 data-number="2.4.4" class="anchored" data-anchor-id="push-work-to-the-data-source"><span class="header-section-number">2.4.4</span> Push work to the data source</h3>
<p>In most cases, actually transmitting the data from the data source to your project is the most costly step in terms of time. So basically anything you can do before you pull the data out should be done before you pull the data out.</p>
<p>Let’s say you really have to provide a very high degree of granularity in your weekly sales dashboard. You can at least do any computations them in the data source and just pull the results back, as opposed to loading all the data and doing the computations in Python or R. More on how to do this in <a href="1-3-data-access.html">Chapter&nbsp;<span>3</span></a>.</p>
<p>This tends to work quite well when you’re creating simple summary statistics and when your database is reasonably fast. If your data source is slow, or if you’re doing complicated machine learning tasks, you may not be able to push that work off to the data source.</p>
</section>
</section>
<section id="store-intermediate-artifacts-in-the-right-format" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="store-intermediate-artifacts-in-the-right-format"><span class="header-section-number">2.5</span> Store intermediate artifacts in the right format</h2>
<p>As you start breaking your processing layer into the different pieces, you’ll find that you have intermediate artifacts to pass the data from one stage to the next.</p>
<p>If all you’re producing is rectangular data frames (or vectors) and you have write access to a database, that’s what you should use.</p>
<p>But very often you don’t have write access to a database or you’ve got other sorts of artifacts that you need to save between steps and can’t go into a database, like machine learning models or rendered plots. In that case, you’ll need to choose how to store your data.</p>
<p><strong>Flat files</strong> are data files that can be moved around just like any other file on your computer. You can put them on your computer, and share them through tools like dropbox, google drive, scp, or more.</p>
<p>The most common is a comma separated value (csv) file, which is just a literal text file of the values in your data with commas as separators.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> You could open it in a text editor and read it if you wanted to.</p>
<p>The advantage of <code>csv</code>s is that they’re completely ubiquitous. Basically every programming language has some way to read in a <code>csv</code> file and work with it.</p>
<p>On the downside, <code>csv</code>s are completely uncompressed. That makes them quite large relative to other sorts of files and slow to read and write. Additionally, because <code>csv</code>s aren’t language-specific, complicated data types may not be preserved when saving to <code>csv</code>. For example, dates are often mangled going into a <code>csv</code> file and back.</p>
<p>They also can only hold rectangular data, so if you’re trying to save a machine learning model, a <code>csv</code> doesn’t make any sense.</p>
<p>Both R and Python have language-specific file types – <code>pickle</code> in Python and <code>rds</code> in R. These are nice because they include some amount of compression and preserve data types when you save a data frame. They also can hold non-rectangular data, which can be great if you want to save a machine learning model.</p>
<p>If you don’t have a database but are storing rectangular data, you should strongly consider using <a href="https://duckdb.org">DuckDB</a>. Its an in-memory database that’s great for analytics use cases. In contrast to a standard database that runs its own live process, there’s no overhead for setting up DuckDB. You just run it against flat files on disk (usually Parquet files), which you can move around like any other. And unlike a <code>csv</code>, <code>pickle</code>, or <code>rds</code> file, a DuckDB is query-able, so you only load the data you need into memory.</p>
<p>It’s hard to stress how cool DuckDB is. Data sets that were big just a few years ago are now medium or even small.</p>
</section>
<section id="choose-where-based-on-update-frequency" class="level2" data-number="2.6">
<h2 data-number="2.6" class="anchored" data-anchor-id="choose-where-based-on-update-frequency"><span class="header-section-number">2.6</span> Choose where based on update frequency</h2>
<p>Let’s say you’ve done your data pre-calculation and have a data set you’re using for the presentation layer. You have to figure out where to keep it.</p>
<p>Where you store your data should be dictated by how often the data is updated.</p>
<p>The simplest answer is to put it in the <em>presentation bundle</em>, which is the code and assets that make up your presentation layer. For example, let’s say you’re building a simple Dash app, <code>app.py</code>.</p>
<p>You could create a project structure like this:</p>
<pre><code>my-project/
├─ app.py
├─ data/
│  ├─ my_data.csv
│  ├─ my_model.pkl</code></pre>
<p>This works well only if your data will be updated at the same cadence as the app or report itself. If your project is an annual report that will be rewritten when you update the data, this can work just great.</p>
<p>But if your data updates more frequently than your project code, you really want to put the data outside the project bundle.</p>
<p>There are a few ways you can do this. The most basic way is just to put the data on a location in your file system that isn’t inside the app bundle.</p>
<p>But when it comes to deployment, data on the file system can be complicated. If you’re writing your app and deploying it on the same server, then you can access the same directory. If not, you’ll need to worry about how to make sure that directory is also accessible on the server where you’re deploying your project.</p>
<p>If you’re not going to store the flat file on the filesystem and you’re in the cloud, the most common option for where it can go is in <em>blob storage</em>. Blob storage allows you to store and recall things by name.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> Each of the major cloud providers has blob storage – AWS’s has <em>s3</em> (short for simple storage service), Azure has <em>Azure Blob Store</em>, and Google has <em>Google Storage</em>.</p>
<p>The nice thing about blob storage is that it can be accessed from anywhere that has access to the cloud. You can also control access using standard cloud identity management tooling, so you could control who has access using individual credentials or could just say that any request for a blob coming from a particular server would be valid.</p>
<p>There are packages in both R and Python for interacting with AWS that are very commonly used for getting access to s3 – <code>{boto3}</code> in Python, and <code>{paws}</code> in R.</p>
<p>There’s also the popular <code>{pins}</code> package in both R and Python that basically wraps using blob storage into neater code. It can use a variety of storage backends, including cloud blob storage, networked or cloud drives like Dropbox, Microsoft365 sites, and Posit Connect.</p>
<p>If you’re still early in your project lifecycle, a google sheet can be a great way to save and recall a flat file. I wouldn’t recommend a google sheet as a permanent home for data, but it can be a good intermediate step while you’re still figuring out what the right answer is for your pipeline.</p>
<p>The primary weakness of a google sheet – that it’s editable by someone who logs in – can also be an asset if that’s something you need.</p>
</section>
<section id="consider-auth-to-data-up-front" class="level2" data-number="2.7">
<h2 data-number="2.7" class="anchored" data-anchor-id="consider-auth-to-data-up-front"><span class="header-section-number">2.7</span> Consider auth to data up front</h2>
<p>If everyone who views your project has the same permissions to see the data, life is easy. You can just allow the project access to the data and check for authorization to view the project.</p>
<p>But if you need to provide different data access to different users, you’re much more constrained. First off, you probably need to use an app rather than a report so that you can respond to which user is accessing the app.</p>
<p>Then you have to figure out how you’re actually going to change data access based on who’s viewing the app.</p>
<p>Sometimes this can be accomplished in the app itself. Many app frameworks pass the username or user groups into the session, and you can write code that changes app behavior based on the user. For example, you can gate access to certain tabs or features of your app based on the user.</p>
<p>Sometimes you’ll actually have to pass database credentials along to the database. If this is the case for you, you’ll need to figure out how to establish the user’s database credentials, how to make sure those credentials stay only in the user’s session, and how those credentials get passed along to the database. This is most commonly done with technologies like Kerberos or OAuth and require coordination with an IT/Admin. More on this topic in <a href="../sec4/4-3-auth.html">Chapter&nbsp;<span>18</span></a>.</p>
</section>
<section id="create-an-api-if-you-need-it" class="level2" data-number="2.8">
<h2 data-number="2.8" class="anchored" data-anchor-id="create-an-api-if-you-need-it"><span class="header-section-number">2.8</span> Create an API if you need it</h2>
<p>In the case of a general purpose three-layer app, it is almost always the case that the middle tier will be an application programming interface (API). In a data science app, separating processing logic into functions is often sufficient. But if you’ve got a long-running bit of business logic, like training an ML model, it’s often helpful to separate it into an API.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may have heard the term REST API or REST-ful.</p>
<p>REST is a set of architectural standards for how to build an API. An API that conforms to those standards is called REST-ful or a REST API.</p>
<p>If you’re using standard methods for constructing an API like R’s <code>{plumber}</code> package or <code>{FastAPI}</code> in Python, they’re going to be REST-ful – or at least close enough for standard usage.</p>
</div>
</div>
<p>You can basically think of an API as a “function as a service”. That is, an API is just one or more functions, but instead of being called within the same process that your app is running or your report is processing, it will run in a completely separate process.</p>
<p>For example, let’s say you’ve got an app that allows users to feed in input data and then generate a model based on that data. If you generate the model inside the app, the user will have the experience of pressing the button to generate the model and having the app seize up on them while they’re waiting. Moreover, other users of the app will find themselves affected by this behavior.</p>
<p>If, instead, the button in the app ships the long-running process to a separate API, it gives you the ability to think about scaling out the presentation layer separate from the business layer.</p>
<p>Luckily, if you’ve written functions for your app, turning them into an API is trivial as packages like <code>{fastAPI}</code> and <code>{plumber}</code> let you turn a function into an API with just the addition of some specially-formatted comments.</p>
</section>
<section id="write-a-data-flow-chart" class="level2" data-number="2.9">
<h2 data-number="2.9" class="anchored" data-anchor-id="write-a-data-flow-chart"><span class="header-section-number">2.9</span> Write a data flow chart</h2>
<p>Once you’ve figured out the project architecture you need, it can be helpful to write a <em>data flow chart</em>.</p>
<p>A data flow chart maps the different project components you’ve got into the three parts of the project and documents all the intermediate artifacts you’re creating along the way.</p>
<p>Once you’ve mapped your project, figuring out where the data should live and in what format will be much simpler.</p>
<p>For example, here’s a very simple data flow chart for the labs in this book. You may want to annotate your data flow charts with other attributes like data types, update frequencies, and where data objects live.</p>
<div class="cell" data-eval="true">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    A[Palmer Penguins \nData Package]
    B[Model Creation Job] 
    C[Model Serving API]
    D[Model Explorerer App]
    E[EDA Report]
    F[Model Creation Report]

    subgraph Data
        A
    end

    subgraph Processing
        B --&gt;|Model| C
    end

    subgraph Presentation
        D
        E
        F
    end

    A --&gt; B
    B --&gt; F
    A --&gt; E
    C --&gt; D
</pre>
</div>
</div>
</div>
</div>
</section>
<section id="comprehension-questions" class="level2" data-number="2.10">
<h2 data-number="2.10" class="anchored" data-anchor-id="comprehension-questions"><span class="header-section-number">2.10</span> Comprehension Questions</h2>
<ol type="1">
<li>What are the layers of a three-layer application architecture? What libraries could you use to implement a three-layer architecture in R or Python?</li>
<li>What are some questions you should explore to reduce the data requirements for your project?</li>
<li>What are some patterns you can use to make big data smaller?</li>
<li>Where can you put intermediate artifacts in a data science project?</li>
<li>What does it mean to “take data out of the bundle”?</li>
</ol>
</section>
<section id="lab2" class="level2" data-number="2.11">
<h2 data-number="2.11" class="anchored" data-anchor-id="lab2"><span class="header-section-number">2.11</span> Lab 2: Build the processing layer</h2>
<p>In the last chapter, we did some EDA of the Palmer Penguins data set and also built an ML model. In this lab, we’re going to take that work we did and turn it into the actual presentation layer for our project.</p>
<section id="step-1-write-the-model-outside-the-bundle-using-vetiver" class="level3" data-number="2.11.1">
<h3 data-number="2.11.1" class="anchored" data-anchor-id="step-1-write-the-model-outside-the-bundle-using-vetiver"><span class="header-section-number">2.11.1</span> Step 1: Write the model outside the bundle using <code>{vetiver}</code></h3>
<p>When we originally wrote our <code>model.qmd</code> script in <a href="1-1-env-as-code.html">Chapter&nbsp;<span>1</span></a>, we didn’t save the model at all.</p>
<p>It seems likely that our model will get updated more frequently than our app, so we don’t want to store it in the app bundle. Later on, I’ll show you how to store it in the cloud. For now, I’m just going to store it in a directory on my computer.</p>
<p>Since</p>
<p>To do it, I’m going to use the <code>{vetiver}</code> package, which is an R and Python package to version, deploy, and monitor a machine learning model.</p>
<p>We can take our existing model, turn it into a <code>{vetiver}</code> model, and save it to the <code>/data/model</code> folder with</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>model.qmd</strong></pre>
</div>
<div class="sourceCode" id="cb2" data-startfrom="45"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python" style="counter-reset: source-line 44;"><span id="cb2-45"><a href="#cb2-45"></a></span>
<span id="cb2-46"><a href="#cb2-46"></a>```{python}</span>
<span id="cb2-47"><a href="#cb2-47"></a><span class="im">from</span> vetiver <span class="im">import</span> VetiverModel</span>
<span id="cb2-48"><a href="#cb2-48"></a>v <span class="op">=</span> VetiverModel(model, model_name<span class="op">=</span><span class="st">'penguin_model'</span>, prototype_data<span class="op">=</span>X)</span>
<span id="cb2-49"><a href="#cb2-49"></a>```</span>
<span id="cb2-50"><a href="#cb2-50"></a></span>
<span id="cb2-51"><a href="#cb2-51"></a><span class="co">## Save to Board</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If <code>/data/model</code> doesn’t exist on your machine, you can create it, or use a directory that does exist.</p>
<p>Whatever path you use, I’d recommend using an absolute file path, rather than a relative one.</p>
</section>
<section id="step-2-create-an-api-to-serve-model-predictions" class="level3" data-number="2.11.2">
<h3 data-number="2.11.2" class="anchored" data-anchor-id="step-2-create-an-api-to-serve-model-predictions"><span class="header-section-number">2.11.2</span> Step 2: Create an API to serve model predictions</h3>
<p>I’m going to say that I need real-time predictions from my model in this case, so I’ll serve the model from an API.</p>
<p>As the point of this lab is to focus on the architecture, I’m just going to use the auto-generation capabilities of <code>{vetiver}</code>. If you’re interested in getting better at writing APIs in general, I encourage you to consult the documentation for <code>{plumber}</code> or <code>{fastAPI}</code>.</p>
<p>If you’ve closed your modeling code, you can get your model back from your pin with:</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>b <span class="op">=</span> pins.board_folder(<span class="st">'data/model'</span>, allow_pickle_read<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a>v <span class="op">=</span> VetiverModel.from_pin(b, <span class="st">'penguin_model'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then you can auto-generate a <code>{fastAPI}</code> from this model with</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>app <span class="op">=</span> VetiverAPI(v, check_prototype<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can run this in your Python session with <code>app.run(port = 8080)</code>. You can then access run your model API by navigating to <code>http://localhost:8080</code> in your browser.</p>
<p>You can play around with the front end there, including trying the provided examples.</p>


</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>Though I’ll argue in <a href="1-4-monitor-log.html">Chapter&nbsp;<span>4</span></a> that you should always use a literate programming tool like Quarto, R Markdown, or Jupyter Notebook.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>There are other delimitors you can use. Tab separated value files (tsv) are something you’ll see occasionally.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The term blob is great to describe the thing you’re saving in blob storage, but it’s actually an abbreviation for <strong>b</strong>inary <strong>l</strong>arge <strong>ob</strong>ject. I think that’s very clever.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../chapters/sec1/1-1-env-as-code.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Environments as Code</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../chapters/sec1/1-3-data-access.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Using databases and data APIs</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright 2022, Alex K Gold</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link active" href="https://github.com/akgold/do4ds" aria-current="page">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/alexkgold">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>